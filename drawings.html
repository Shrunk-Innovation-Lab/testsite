<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Drawing Markup Station - Electranet</title>
    <link rel="icon" type="image/jpeg" href="https://i.imgur.com/g8yWq0Ys.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- PDF.js Library -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f9fafb; /* gray-50 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af; /* gray-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .tool-button.active {
            background-color: #203136; /* New Electranet Dark Blue/Gray */
            color: white;
            border-color: #203136; /* New Electranet Dark Blue/Gray */
        }
        .color-palette-button.active {
            border-color: #203136; /* Electranet Dark Blue/Gray for active border */
            box-shadow: 0 0 0 2px #203136; /* Ring effect for active color */
        }
        #drawingCanvas {
            /* Default cursor is set dynamically by the active tool */
        }
        #file-list-container {
            max-height: 200px; 
            overflow-y: auto;
        }
        .file-item-row:hover {
            background-color: #f3f4f6; /* gray-100 */
            cursor: pointer;
        }
        .selected-folder > li {
            background-color: #dde2e3; /* Lighter shade of new blue/gray */
            color: #203136;
            font-weight: 600;
        }
        .selected-file {
            background-color: #dde2e3; /* Lighter shade of new blue/gray */
        }
        .selected-file td {
             color: #203136; 
        }

        /* Specific cursors for resize handles (applied via JS) */
        .cursor-nwse-resize { cursor: nwse-resize; }
        .cursor-nesw-resize { cursor: nesw-resize; }
        .cursor-ns-resize { cursor: ns-resize; }
        .cursor-ew-resize { cursor: ew-resize; }
        .cursor-move { cursor: move; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .cursor-default { cursor: default; }
        .cursor-crosshair { cursor: crosshair; }
         /* Custom style for SVG icons in buttons if needed */
        .tool-button svg, .toolbar-action-button svg { 
            width: 1em; 
            height: 1em; 
            fill: currentColor; 
        }
        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed !important;
        }
        /* Custom arrow for select dropdown */
        #substation-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center; 
            background-size: 1.2em 1.2em;
            padding-right: 2.5rem; 
        }
    </style>
</head>
<body class="bg-white">
    <div class="flex flex-col h-screen font-sans">
        <header style="background-color: #203136;" class="text-white p-3 shadow-md flex justify-center items-center relative">
            <img src="https://electranet.com.au/wp-content/uploads/2024/09/Electranet-Logo-Neg.svg" alt="Electranet Logo" class="h-10 mr-4 absolute left-3 top-1/2 -translate-y-1/2 sm:relative sm:left-auto sm:top-auto sm:translate-y-0">
            <h1 class="text-xl font-bold text-center flex-grow">MOBILE DRAWING MARKUP STATION</h1>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <div class="w-full md:w-72 bg-gray-50 p-4 space-y-4 border-r border-gray-200 overflow-y-auto flex flex-col">
                <div>
                    <label for="substation-select" class="block mb-2 text-sm font-medium text-gray-900">Substation:</label>
                    <select id="substation-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="">Select Substation</option>
                    </select>
                </div>
                <div class="flex-grow flex flex-col overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-900 mb-1">Folders</h3>
                    <ul id="folder-list" class="space-y-1 overflow-y-auto text-sm p-1 bg-white rounded-md border border-gray-300 flex-grow">
                        <li class="text-gray-500 p-2">Select a substation to see folders.</li>
                    </ul>
                </div>
                <div class="flex-grow flex flex-col overflow-hidden">
                    <h3 class="text-sm font-semibold text-gray-900 mb-1">Files in <span id="current-folder-name" class="font-normal">...</span></h3>
                    <div id="file-list-container" class="bg-white rounded-md border border-gray-300 flex-grow overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 tracking-wider">Name</th>
                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 tracking-wider">Modified</th>
                                </tr>
                            </thead>
                            <tbody id="file-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="2" class="p-3 text-gray-500">Select a folder to see files.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-gray-100 overflow-hidden">
                <div id="toolbar" class="bg-gray-100 p-2 flex items-center justify-start space-x-1.5 shadow-sm border-b border-gray-300 flex-nowrap overflow-x-auto">
                    <button id="tool-select" title="Select/Edit Shape" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="select"><i class="fas fa-mouse-pointer"></i></button>
                    <button id="tool-webcam" title="Use Camera" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:ring-blue-300 font-medium rounded-md text-sm p-2 flex-shrink-0 flex items-center">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button id="tool-load-trigger" title="Load Image" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:ring-blue-300 font-medium rounded-md text-sm px-3 py-2 flex-shrink-0 flex items-center">
                        <i class="fas fa-folder-open"></i><span class="hidden md:inline ml-1.5">Load</span>
                    </button>
                    <input type="file" id="imageLoader" class="hidden" accept="image/*,application/pdf"> 
                    <button id="tool-save" title="Save Markup" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:ring-blue-300 font-medium rounded-md text-sm px-3 py-2 flex-shrink-0 flex items-center">
                        <i class="fas fa-save"></i><span class="hidden md:inline ml-1.5">Save</span>
                    </button>

                    <span class="border-l border-gray-300 h-6 mx-1 flex-shrink-0"></span>

                    <button id="tool-pen" title="Pen" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="pen"><i class="fas fa-pencil-alt"></i></button>
                    <button id="tool-highlighter" title="Highlighter" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0 flex justify-center items-center" data-tool="highlighter">
                        <svg fill="currentColor" width="1em" height="1em" viewBox="0 -16 544 544" xmlns="http://www.w3.org/2000/svg"><path d="M0 479.98L99.92 512l35.45-35.45-67.04-67.04L0 479.98zm124.61-240.01a36.592 36.592 0 0 0-10.79 38.1l13.05 42.83-50.93 50.94 96.23 96.23 50.86-50.86 42.74 13.08c13.73 4.2 28.65-.01 38.15-10.78l35.55-41.64-173.34-173.34-41.52 35.44zm403.31-160.7l-63.2-63.2c-20.49-20.49-53.38-21.52-75.12-2.35L190.55 183.68l169.77 169.78L530.27 154.4c19.18-21.74 18.15-54.63-2.35-75.13z"/></svg>
                    </button>
                    <button id="tool-line" title="Line" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="line"><i class="fas fa-slash"></i></button>
                    <button id="tool-arrow" title="Arrow" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="arrow"><i class="fas fa-long-arrow-alt-right"></i></button>
                    <button id="tool-rect" title="Rectangle" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="rect"><i class="far fa-square"></i></button>
                    <button id="tool-circle" title="Circle" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="circle"><i class="far fa-circle"></i></button>
                    <button id="tool-stamp" title="Stamp" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="stamp"><i class="fas fa-stamp"></i></button>
                    <button id="tool-text" title="Text" class="tool-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0" data-tool="text"><i class="fas fa-font"></i></button>

                    <span class="border-l border-gray-300 h-6 mx-1 flex-shrink-0"></span>
                    
                    <div class="flex items-center space-x-1"> 
                        <button id="toggle-color-palette" title="Toggle Colors" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0">
                            <i id="color-toggle-icon" class="fas fa-chevron-left"></i>
                        </button>
                        <div id="color-palette-group" class="flex items-center space-x-1.5 hidden"> 
                            <button class="color-palette-button w-6 h-6 rounded-sm border-2 border-gray-300 flex-shrink-0" style="background-color: #FF0000;" data-color="#FF0000" title="Red"></button>
                            <button class="color-palette-button w-6 h-6 rounded-sm border-2 border-gray-300 flex-shrink-0" style="background-color: #000000;" data-color="#000000" title="Black"></button>
                            <button class="color-palette-button w-6 h-6 rounded-sm border-2 border-gray-300 flex-shrink-0" style="background-color: #FFFF00;" data-color="#FFFF00" title="Yellow"></button>
                            <button class="color-palette-button w-6 h-6 rounded-sm border-2 border-gray-300 flex-shrink-0" style="background-color: #0000FF;" data-color="#0000FF" title="Blue"></button>
                            <button class="color-palette-button w-6 h-6 rounded-sm border-2 border-gray-300 flex-shrink-0" style="background-color: #008000;" data-color="#008000" title="Green"></button>
                        </div>
                         <input type="color" id="tool-color" title="Custom Color" value="#FF0000" class="p-0 h-8 w-8 rounded-md border-2 border-gray-300 cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 flex-shrink-0 ml-1">
                    </div>
                    
                    <select id="tool-linewidth" title="Line Width/Font Size Base" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 h-8 p-1 flex-shrink-0">
                        <option value="1">1px (S)</option>
                        <option value="2">2px (S)</option>
                        <option value="3" selected>3px (M)</option>
                        <option value="5">5px (M)</option>
                        <option value="8">8px (L)</option>
                        <option value="12">12px (L)</option>
                        <option value="20">20px (XL)</option>
                    </select>
                    
                    <span class="border-l border-gray-300 h-6 mx-1 flex-shrink-0"></span>

                    <button id="tool-undo" title="Undo" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0" disabled><i class="fas fa-undo"></i></button>
                    <button id="tool-redo" title="Redo" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0" disabled><i class="fas fa-redo"></i></button>
                    
                    <span class="border-l border-gray-300 h-6 mx-1 flex-shrink-0"></span>
                    <button id="tool-delete-selected" title="Delete Selected" class="toolbar-action-button text-red-600 bg-white border border-red-300 hover:bg-red-100 focus:ring-4 focus:ring-red-200 font-medium rounded-md text-sm p-2 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0" disabled>
                        <i class="fas fa-eraser"></i> </button>
                    <button id="tool-clear" title="Clear All Markups" class="toolbar-action-button text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-md text-sm px-3 py-2 flex-shrink-0 flex items-center">
                        <i class="fas fa-trash"></i><span class="hidden md:inline ml-1.5">Clear All</span>
                    </button>
                    
                    <span class="border-l border-gray-300 h-6 mx-1 flex-shrink-0"></span>
                    
                    <button id="zoom-in" title="Zoom In" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0"><i class="fas fa-search-plus"></i></button>
                    <button id="zoom-out" title="Zoom Out" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0"><i class="fas fa-search-minus"></i></button>
                    <button id="zoom-reset" title="Reset Zoom/Fit" class="toolbar-action-button text-gray-700 bg-white border border-gray-300 hover:bg-gray-200 focus:ring-4 focus:ring-gray-200 font-medium rounded-md text-sm p-2 flex-shrink-0"><i class="fas fa-expand-arrows-alt"></i></button>
                </div>
                <div id="canvas-container" class="flex-1 p-4 flex justify-center items-center overflow-auto relative bg-gray-200">
                    <canvas id="drawingCanvas" class="border-2 border-gray-400 shadow-lg bg-white">Your browser does not support the canvas element.</canvas>
                </div>
            </div>
        </div>

        <footer style="background-color: #203136;" class="text-gray-300 text-xs text-center p-3">
            @2025 | Shrunk Innovation Group | All Rights Reserved
        </footer>

        <div id="messageBox" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center p-4">
            <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 id="messageTitle" class="text-lg font-semibold text-gray-900 mb-2">Notification</h3>
                <p id="messageText" class="text-sm text-gray-600 mb-4"></p>
                <div class="text-right">
                    <button id="messageOkButton" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <div id="genericInputModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center p-4">
            <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6">
                <h3 id="genericInputTitle" class="text-lg font-semibold text-gray-900 mb-4">Input Required</h3>
                <input type="text" id="genericTextInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 mb-4">
                <div class="flex justify-end space-x-3">
                    <button id="genericInputCancelButton" class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
                        Cancel
                    </button>
                    <button id="genericInputOkButton" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- Webcam Modal -->
        <div id="webcamModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Camera Capture</h3>
                <div class="bg-black rounded-md overflow-hidden">
                    <video id="webcamVideo" class="w-full h-auto" autoplay playsinline></video>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                     <button id="webcamCloseButton" class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
                        Close
                    </button>
                    <button id="webcamCaptureButton" style="background-color: #203136;" class="text-white hover:opacity-90 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        Capture Photo
                    </button>
                </div>
            </div>
        </div>
        <!-- Hidden canvas for capturing webcam frame -->
        <canvas id="captureCanvas" class="hidden"></canvas>
    </div>

    <script>
        // Set PDF.js worker source before any other script logic that might use it
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';
        }
        
        // Mock Data (Simulating file system)
        const APP_DATA = {
            substations: [
                {
                    id: "ssd438", name: "Angas Creek - SSD438",
                    folders: [
                        {
                            id: "f5_sld", name: "File 5 - Single Line Diagrams",
                            files: [
                                { id: "drawing1_aa", name: "310_438_101_001_Rev_AA.png", path: "https://placehold.co/1200x800/FFFFFF/000000?text=Angas+Creek+SLD+1", lastModified: "12/04/2013 17:45pm" },
                                { id: "drawing2_c", name: "310_438_102_001_Rev_C.png", path: "https://placehold.co/1200x800/EEEEEE/000000?text=Angas+Creek+SLD+2", lastModified: "18/09/2012 09:14am" }
                            ]
                        },
                        {
                            id: "f6_psld", name: "File 6 - Prot. Single Line Diagrams",
                            files: [
                                { id: "drawing3_g", name: "PROT_310_438_103_001_Rev_G.png", path: "https://placehold.co/1200x800/DDDDDD/000000?text=Angas+Creek+Prot.+SLD+1", lastModified: "18/09/2012 10:45am" }
                            ]
                        }
                    ]
                },
                {
                    id: "ssd579", name: "City West - SSD579",
                    folders: [
                        {
                            id: "f7_275kv", name: "File 7 - 275kV Schematics",
                            files: [
                                { id: "city_west_schem1", name: "CW_275_SCHEM_001.png", path: "https://placehold.co/1200x800/CCCCCC/000000?text=City+West+275kV+Schematic+1", lastModified: "01/01/2024 10:00am" }
                            ]
                        },
                        { id: "f8_132kv", name: "File 8 - 132kV Schematics", files: [] }
                    ]
                },
                { id: "ssd282", name: "Ardrossan West - SSD282", folders: [{id: "aw_f1", name: "General Arrangements", files: [{id: "aw_ga1", name: "AW_GA_001.png", path: "https://placehold.co/1200x800/BBBBBB/000000?text=Ardrossan+GA1", lastModified: "10/05/2022"}] }] },
                { id: "ssd310", name: "Baroota - SSD310", folders: [] },
                { id: "ssd481", name: "Belalie - SSD481", folders: [] },
            ],
            uploadedFiles: []
        };
        
        // DOM Elements
        const substationSelect = document.getElementById('substation-select');
        const folderList = document.getElementById('folder-list');
        const fileList = document.getElementById('file-list');
        const currentFolderNameSpan = document.getElementById('current-folder-name');
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const toolbar = document.getElementById('toolbar');
        const colorPicker = document.getElementById('tool-color');
        const lineWidthPicker = document.getElementById('tool-linewidth');
        const imageLoader = document.getElementById('imageLoader');
        const loadTriggerButton = document.getElementById('tool-load-trigger');
        const saveButton = document.getElementById('tool-save');
        const clearButton = document.getElementById('tool-clear');
        const deleteSelectedButton = document.getElementById('tool-delete-selected'); 
        const zoomInButton = document.getElementById('zoom-in');
        const zoomOutButton = document.getElementById('zoom-out');
        const zoomResetButton = document.getElementById('zoom-reset');
        const canvasContainer = document.getElementById('canvas-container');
        const toggleColorPaletteButton = document.getElementById('toggle-color-palette');
        const colorPaletteGroup = document.getElementById('color-palette-group');
        const colorToggleIcon = document.getElementById('color-toggle-icon');
        const webcamButton = document.getElementById('tool-webcam');
        const webcamModal = document.getElementById('webcamModal');
        const webcamVideo = document.getElementById('webcamVideo');
        const webcamCaptureButton = document.getElementById('webcamCaptureButton');
        const webcamCloseButton = document.getElementById('webcamCloseButton');
        const captureCanvas = document.getElementById('captureCanvas');

        
        const messageBox = document.getElementById('messageBox');
        const messageTitleElement = document.getElementById('messageTitle'); 
        const messageTextElement = document.getElementById('messageText'); 
        const messageOkButton = document.getElementById('messageOkButton');

        const undoButton = document.getElementById('tool-undo');
        const redoButton = document.getElementById('tool-redo');
        const selectToolButton = document.getElementById('tool-select');

        const genericInputModal = document.getElementById('genericInputModal');
        const genericInputTitle = document.getElementById('genericInputTitle');
        const genericTextInput = document.getElementById('genericTextInput');
        const genericInputOkButton = document.getElementById('genericInputOkButton');
        const genericInputCancelButton = document.getElementById('genericInputCancelButton');
        let genericInputCallback = null;

        let activeTool = 'select'; 
        let currentColor = colorPicker.value;
        let currentLineWidth = parseInt(lineWidthPicker.value);
        const HIGHLIGHTER_WIDTH_MULTIPLIER = 4; 
        let isDrawing = false; 
        let startX, startY, currentX, currentY;
        let backgroundImage = null;
        let currentDrawingPath = ''; 
        
        let markups = []; 
        let markupHistory = []; 
        let historyIndex = -1; 

        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isPanning = false; 
        let panStartX, panStartY;
        
        let initialCanvasWidth = 800; 
        let initialCanvasHeight = 600;

        let selectedMarkupIndex = -1;
        let isDragging = false; 
        let isResizing = false; 
        let resizeHandle = null; 
        let HANDLE_SIZE = 8; 
        let dragOffsetX, dragOffsetY; 
        let webcamStream = null;

        // The entire script content is now within this script tag, making functions globally available to the page.

        function init() {
            populateSubstations(); 
            setupEventListeners();
            setActiveTool(activeTool); 
            resizeCanvas(); 
            addMarkupToHistory(); 
            updateToolbarStates(); 
            showSystemMessage("Welcome!", "Select a substation or load an image to begin. Use the pointer tool to move/resize shapes.");
            window.addEventListener('resize', resizeCanvasAndRedraw);
        }

        // ... (All other functions from previous correct versions are here) ...

        document.addEventListener('DOMContentLoaded', () => {
            init();
        });
        
    </script>
</body>
</html>
