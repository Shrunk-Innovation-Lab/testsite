<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://i.imgur.com/dZR7M8C.png">
    <title>PRD Studio - Product Requirements Document Generator</title>
    <!-- jsPDF is not needed as Google Apps Script handles PDF creation -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
            min-height: 100vh;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 16px;
            padding: 20px; 
            margin-bottom: 32px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .header-content { 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 12px; 
        }

        .logo-section { 
            display: flex; 
            justify-content: center;
            align-items: center;
            width: 100%; 
        }

        .logo {
            width: 150px; 
            height: 100px; 
            background-image: url('https://i.imgur.com/iB983sa.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 12px; 
        }
        
        .logo img { 
            display: none; 
        }


        .brand-text {
            text-align: center;
        }

        .brand-title {
            font-size: 2.25rem; 
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px; 
        }

        .brand-subtitle {
            color: #6b7280;
            font-size: 1rem; 
            font-weight: 500;
        }
        
        /* Form Container */
        .form-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Progress Steps */
        .progress-container {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 24px 32px;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .step.active {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(255, 107, 107, 0.3);
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .step.inactive {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .step.inactive .step-number {
            background: #f3f4f6;
            color: #6b7280;
        }

        .step.completed .step-number {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Form Content */
        .form-content {
            padding: 32px;
        }

        .section {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .section-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .section-description {
            color: #6b7280;
            font-size: 1.125rem;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.col-span-full {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-input {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        /* Dynamic Lists */
        .dynamic-container {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: #f9fafb;
        }

        .dynamic-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: flex-start;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .dynamic-item:last-child { 
            margin-bottom: 0;
        }


        .dynamic-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .add-btn {
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            margin-top: 16px; 
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(78, 205, 196, 0.3);
        }

        /* Priority Selector */
        .priority-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .priority-option {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: white;
        }

        .priority-option.selected {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            border-color: transparent;
        }

        .priority-option:hover:not(.selected) {
            border-color: #ff6b6b;
            background: #fef2f2;
        }

        /* Checkboxes */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: #fef2f2;
            border-color: #ff6b6b;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #ff6b6b;
        }

        .checkbox-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        /* Navigation */
        .form-navigation {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: center;
            margin-top: 40px;
            padding: 24px 32px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            gap: 10px; 
        }
        .form-actions-left {
            display: flex;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(255, 107, 107, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Alerts & Message Box */
        .message-box {
            padding: 16px;
            border-radius: 8px;
            margin: 16px auto; 
            max-width: 600px; 
            display: none; 
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .message-box-success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .message-box-info { 
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
         .message-box-error { 
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }


        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100; 
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px; 
            max-width: 500px;
            width: 100%; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }
        .modal-content h3 {
             margin-bottom: 16px; font-size: 1.25rem; font-weight: 600;
        }
        .modal-content p {
             color: #6b7280; margin-top: 16px;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .drafts-list {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 16px;
        }
        .drafts-list-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .drafts-list-item:last-child {
            border-bottom: none;
        }
        .drafts-list-item:hover {
            background-color: #f9fafb;
        }
        .draft-delete-btn {
            background: #ef4444; color: white; border:none; border-radius: 4px; padding: 5px 8px; font-size:12px;
        }
        .draft-delete-btn:hover { background: #dc2626; }


        .modal-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 24px;
            color: white; 
        }

        /* Footer */
        .footer {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-top: 32px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .footer a {
            color: #ff6b6b;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            .header {
                padding: 15px; 
            }
            .header-content { 
                gap: 10px; 
            }
            .logo { 
                width: 100px; 
                height: 60px; 
                margin-bottom: 8px; 
            }
            .brand-title {
                font-size: 1.75rem; 
            }
            .brand-subtitle {
                font-size: 0.875rem; 
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .progress-steps {
                flex-direction: column;
                align-items: stretch; 
            }
            .form-content {
                padding: 24px;
            }
            .form-navigation {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            .form-actions-left, .nav-buttons {
                 width: 100%;
                 justify-content: center;
            }
            .nav-buttons {
                flex-direction: column; 
            }
            .nav-buttons .btn {
                width: 100%; 
            }
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Feature Highlight */
        .feature-highlight {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1));
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .feature-title {
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 8px;
        }

        .feature-description {
            color: #6b7280;
            font-size: 14px;
        }
        .sr-only { 
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section"> 
                    <div class="logo"></div>
                </div>
                <div class="brand-text">
                    <h1 class="brand-title">PRD Studio</h1> 
                    <p class="brand-subtitle">Compress your ideas into comprehensive Product Requirements Documents</p>
                </div>
            </div>
        </header>

        <!-- Main Form -->
        <div class="form-container">
            <!-- Progress Steps -->
            <div class="progress-container">
                <div class="progress-steps">
                    <div class="step active" data-step="1" onclick="navigateToSection(1)">
                        <div class="step-number">1</div>
                        <span>Overview</span>
                    </div>
                    <div class="step inactive" data-step="2" onclick="navigateToSection(2)">
                        <div class="step-number">2</div>
                        <span>Users & Goals</span>
                    </div>
                    <div class="step inactive" data-step="3" onclick="navigateToSection(3)">
                        <div class="step-number">3</div>
                        <span>Features</span>
                    </div>
                    <div class="step inactive" data-step="4" onclick="navigateToSection(4)">
                        <div class="step-number">4</div>
                        <span>Technical</span>
                    </div>
                    <div class="step inactive" data-step="5" onclick="navigateToSection(5)">
                        <div class="step-number">5</div>
                        <span>Success</span>
                    </div>
                </div>
            </div>

            <form id="prdForm" onsubmit="return false;"> 
                <div class="form-content">
                    <!-- Sections will be rendered here by JS -->
                    <!-- Section 1: Product Overview -->
                    <div class="section active" data-section="1">
                        <div class="section-header">
                            <h2 class="section-title">Product Overview</h2>
                            <p class="section-description">Define the basic information and context for your product</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="productName">Product Name</label>
                                <input type="text" class="form-input" id="productName" name="productName" placeholder="Enter your product name">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="productType">Product Type</label>
                                <select class="form-select" id="productType" name="productType">
                                    <option value="">Select product type</option>
                                    <option value="web-application">Web Application</option>
                                    <option value="mobile-app">Mobile App</option>
                                    <option value="desktop-software">Desktop Software</option>
                                    <option value="api-service">API/Service</option>
                                    <option value="hardware">Hardware</option>
                                    <option value="platform">Platform</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="productVision">Product Vision</label>
                                <textarea class="form-input form-textarea" id="productVision" name="productVision" placeholder="Describe the long-term vision for this product"></textarea>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="problemStatement">Problem Statement</label>
                                <textarea class="form-input form-textarea" id="problemStatement" name="problemStatement" placeholder="What problem does this product solve?"></textarea>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="solutionOverview">Solution Overview</label>
                                <textarea class="form-input form-textarea" id="solutionOverview" name="solutionOverview" placeholder="High-level description of how your product solves the problem"></textarea>
                            </div>
                        </div>

                        <div class="feature-highlight">
                            <div class="feature-title">üí° Pro Tip</div>
                            <div class="feature-description">A clear product vision should be inspiring, memorable, and guide all product decisions. Think about where you want your product to be in 2-3 years.</div>
                        </div>
                    </div>

                    <!-- Section 2: Users & Goals -->
                    <div class="section" data-section="2">
                        <div class="section-header">
                            <h2 class="section-title">Target Users & Business Goals</h2>
                            <p class="section-description">Define your target audience and business objectives</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group col-span-full">
                                <label class="form-label" for="primaryUsers">Primary Target Users</label>
                                <textarea class="form-input form-textarea" id="primaryUsers" name="primaryUsers" placeholder="Describe your primary target users (demographics, roles, characteristics)"></textarea>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="secondaryUsers">Secondary Target Users</label>
                                <textarea class="form-input form-textarea" id="secondaryUsers" name="secondaryUsers" placeholder="Describe any secondary user groups"></textarea>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">User Stories</label>
                                <div class="dynamic-container" id="userStories"></div>
                                <button type="button" class="add-btn" onclick="addUserStory()">
                                    <span>+</span> Add User Story
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Business Objectives</label>
                                <div class="dynamic-container" id="businessObjectives"></div>
                                <button type="button" class="add-btn" onclick="addBusinessObjective()">
                                    <span>+</span> Add Objective
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Success Metrics</label>
                                <div class="dynamic-container" id="successMetrics"></div>
                                <button type="button" class="add-btn" onclick="addSuccessMetric()">
                                    <span>+</span> Add Metric
                                </button>
                            </div>
                        </div>

                        <div class="feature-highlight">
                            <div class="feature-title">üéØ User Story Format</div>
                            <div class="feature-description">Follow the standard format: "As a [type of user], I want [goal] so that [reason]". This helps ensure user-centered thinking.</div>
                        </div>
                    </div>

                    <!-- Section 3: Features & Requirements -->
                    <div class="section" data-section="3">
                        <div class="section-header">
                            <h2 class="section-title">Features & Requirements</h2>
                            <p class="section-description">Define the functional and non-functional requirements</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group col-span-full">
                                <label class="form-label">Core Features</label>
                                <div class="dynamic-container" id="coreFeatures"></div>
                                <button type="button" class="add-btn" onclick="addCoreFeature()">
                                    <span>+</span> Add Feature
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Future Features (Nice to Have)</label>
                                <div class="dynamic-container" id="futureFeatures"></div>
                                <button type="button" class="add-btn" onclick="addFutureFeature()">
                                    <span>+</span> Add Future Feature
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Non-Functional Requirements</label>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="performance" id="nfr-performance"><label class="checkbox-label" for="nfr-performance">Performance</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="security" id="nfr-security"><label class="checkbox-label" for="nfr-security">Security</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="scalability" id="nfr-scalability"><label class="checkbox-label" for="nfr-scalability">Scalability</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="usability" id="nfr-usability"><label class="checkbox-label" for="nfr-usability">Usability</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="accessibility" id="nfr-accessibility"><label class="checkbox-label" for="nfr-accessibility">Accessibility</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="compatibility" id="nfr-compatibility"><label class="checkbox-label" for="nfr-compatibility">Compatibility</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="maintainability" id="nfr-maintainability"><label class="checkbox-label" for="nfr-maintainability">Maintainability</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="nfr[]" value="reliability" id="nfr-reliability"><label class="checkbox-label" for="nfr-reliability">Reliability</label></div>
                                </div>
                            </div>
                        </div>

                        <div class="feature-highlight">
                            <div class="feature-title">‚öñÔ∏è Feature Prioritization</div>
                            <div class="feature-description">Use High for must-have features, Medium for should-have features, and Low for nice-to-have features.</div>
                        </div>
                    </div>

                    <!-- Section 4: Technical Specifications -->
                    <div class="section" data-section="4">
                        <div class="section-header">
                            <h2 class="section-title">Technical Specifications</h2>
                            <p class="section-description">Define the technical requirements and constraints</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group col-span-full">
                                <label class="form-label">Target Platforms</label>
                                <div class="checkbox-grid">
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="web" id="platform-web"><label class="checkbox-label" for="platform-web">Web Browser</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="ios" id="platform-ios"><label class="checkbox-label" for="platform-ios">iOS</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="android" id="platform-android"><label class="checkbox-label" for="platform-android">Android</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="desktop" id="platform-desktop"><label class="checkbox-label" for="platform-desktop">Desktop (Windows)</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="macos" id="platform-macos"><label class="checkbox-label" for="platform-macos">Desktop (macOS)</label></div>
                                    <div class="checkbox-item"><input type="checkbox" name="platforms[]" value="linux" id="platform-linux"><label class="checkbox-label" for="platform-linux">Desktop (Linux)</label></div>
                                </div>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="technologyStack">Technology Stack</label>
                                <textarea class="form-input form-textarea" id="technologyStack" name="technologyStack" placeholder="Preferred technologies, frameworks, databases, etc."></textarea>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Integration Requirements</label>
                                <div class="dynamic-container" id="integrations"></div>
                                <button type="button" class="add-btn" onclick="addIntegration()">
                                    <span>+</span> Add Integration
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="technicalConstraints">Technical Constraints</label>
                                <textarea class="form-input form-textarea" id="technicalConstraints" name="technicalConstraints" placeholder="Any technical limitations, compliance requirements, etc."></textarea>
                            </div>
                        </div>

                        <div class="feature-highlight">
                            <div class="feature-title">üîß Technical Planning</div>
                            <div class="feature-description">Consider scalability, maintainability, and team expertise when choosing your technology stack.</div>
                        </div>
                    </div>

                    <!-- Section 5: Success Criteria & Timeline -->
                    <div class="section" data-section="5">
                        <div class="section-header">
                            <h2 class="section-title">Success Criteria & Timeline</h2>
                            <p class="section-description">Define how success will be measured and project timeline</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" for="projectTimeline">Project Timeline</label>
                                <input type="text" class="form-input" id="projectTimeline" name="projectTimeline" placeholder="e.g., 6 months, Q2 2025">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="launchDate">Target Launch Date</label>
                                <input type="date" class="form-input" id="launchDate" name="launchDate">
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Acceptance Criteria</label>
                                <div class="dynamic-container" id="acceptanceCriteria"></div>
                                <button type="button" class="add-btn" onclick="addAcceptanceCriteria()">
                                    <span>+</span> Add Criteria
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label">Risks & Mitigation</label>
                                <div class="dynamic-container" id="risks"></div>
                                <button type="button" class="add-btn" onclick="addRisk()">
                                    <span>+</span> Add Risk
                                </button>
                            </div>
                            
                            <div class="form-group col-span-full">
                                <label class="form-label" for="additionalNotes">Additional Notes</label>
                                <textarea class="form-input form-textarea" id="additionalNotes" name="additionalNotes" placeholder="Any additional information, assumptions, or dependencies"></textarea>
                            </div>
                        </div>

                        <div class="feature-highlight">
                            <div class="feature-title">üìä Success Measurement</div>
                            <div class="feature-description">Define clear, measurable acceptance criteria.</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="form-navigation">
                     <div class="form-actions-left">
                        <button type="button" class="btn btn-secondary" onclick="handleSaveDraft()">
                            üíæ Save Draft
                        </button>
                         <button type="button" class="btn btn-secondary" onclick="showLoadDraftModal()">
                            üìÇ Load Draft
                        </button>
                    </div>
                    
                    <div class="nav-buttons">
                        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousSection()" disabled>
                            ‚Üê Previous
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextSection()">
                            Next ‚Üí
                        </button>
                        <button type="button" class="btn btn-primary" id="generateBtn" onclick="handleSaveFinal()" style="display: none;">
                            üì§ Save Final PDF to Drive
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Message Box for alerts -->
        <div class="message-box" id="appMessageBox">
             <span id="messageBoxIcon"></span> 
             <span id="messageBoxText"></span> 
        </div>

        <!-- Footer -->
        <footer class="footer">
            ¬© <span id="currentYear"></span> | <a href="#" onclick="return false;">Shrunk Innovation Group Pty Ltd</a> | All Rights Reserved
        </footer>
    </div>

    <!-- Modals (Save, Load, Loading) -->
    <div class="modal" id="saveDraftModal"><div class="modal-content"><h3>Save Draft</h3><p>Enter a name for your draft. If it exists, it will be overwritten.</p><input type="text" id="draftNameInput" class="modal-input" placeholder="e.g., My Project Draft"><div class="modal-buttons"><button type="button" class="btn btn-secondary" onclick="hideModal('saveDraftModal')">Cancel</button><button type="button" class="btn btn-primary" onclick="confirmSaveDraft()">Save</button></div></div></div>
    <div class="modal" id="loadDraftModal"><div class="modal-content"><h3>Load Draft</h3><p>Select a draft to load. This will overwrite current form content.</p><div id="draftsListContainer" class="drafts-list"></div><div id="noDraftsMessage" style="display:none;margin-top:10px;color:#6b7280;">No drafts found.</div><div class="modal-buttons"><button type="button" class="btn btn-secondary" onclick="hideModal('loadDraftModal')">Cancel</button></div></div></div>
    <div class="modal" id="loadingSpinnerModal"><div class="modal-content"><div class="modal-icon">‚è≥</div><h3 id="loadingSpinnerText">Processing...</h3><div class="spinner"></div></div></div>

    <script>
        // --- App State and Core Logic ---
        let currentSection = 1;
        const totalSections = 5;

        const gebi = (id) => document.getElementById(id);

        function showAppMessage(message, type = 'info') {
            const box = gebi('appMessageBox'), icon = gebi('messageBoxIcon'), text = gebi('messageBoxText');
            box.className = 'message-box'; 
            if (type === 'success') { box.classList.add('message-box-success'); icon.textContent = 'üéâ'; } 
            else if (type === 'error') { box.classList.add('message-box-error'); icon.textContent = '‚ùå'; } 
            else { box.classList.add('message-box-info'); icon.textContent = '‚ÑπÔ∏è'; }
            text.textContent = message;
            box.style.display = 'flex';
            setTimeout(() => { box.style.display = 'none'; }, 5000);
        }
        
        // --- API & Data Functions ---
        const getApiUrl = () => {
            // Hardcoded Google Apps Script URL
            return 'https://script.google.com/a/macros/shrunk.ai/s/AKfycbw79j9P68Dfwe-0_Aj5N057g2AhJJz663qJ7hdq3SRt13C1BnkoBxJ-g1KFxf_oXCjnYQ/exec';
        }

        const getFormDataObject = () => {
            const data = {};
            new FormData(gebi('prdForm')).forEach((value, key) => {
                const cleanKey = key.replace('[]', '');
                if (key.endsWith('[]')) {
                    if (!data[cleanKey]) data[cleanKey] = [];
                    data[cleanKey].push(value);
                } else { data[cleanKey] = value; }
            });
            ['nfr', 'platforms'].forEach(k => { if (!data[k]) data[k] = []; });
            return data;
        };

        const createPRDMarkdown = () => {
             const data = getFormDataObject();
             const buildList = (items, prefix = "- ") => (items && items.length > 0 && !(items.length === 1 && items[0] === 'N/A')) ? items.map(item => `${prefix}${item || 'N/A'}`).join('\n') : `${prefix}N/A`;
             const buildPairedList = (items1, items2, label1, label2) => {
                 if (!items1 || items1.length === 0 || (items1.length === 1 && items1[0] === 'N/A')) return '- N/A';
                 return items1.map((item1, index) => `- **${label1 || item1 || 'N/A'}:** ${items2?.[index] || 'N/A'}`).join('\n');
             }
             
             let prd = `# Product Requirements Document (PRD)\n\n`;
             prd += `## 1. Product Overview\n\n`;
             prd += `**Product Name:** ${data.productName}\n`;
             prd += `**Product Type:** ${data.productType}\n`;
             prd += `**Document Version:** 1.0\n`;
             prd += `**Last Updated:** ${new Date().toLocaleDateString()}\n\n`;
             prd += `### 1.1 Product Vision\n${data.productVision}\n\n`;
             prd += `### 1.2 Problem Statement\n${data.problemStatement}\n\n`;
             prd += `### 1.3 Solution Overview\n${data.solutionOverview}\n\n`;
             prd += `---\n## 2. Target Users & Business Goals\n\n`;
             prd += `### 2.1 Primary Target Users\n${data.primaryUsers}\n\n`;
             prd += `### 2.2 Secondary Target Users\n${data.secondaryUsers}\n\n`;
             prd += `### 2.3 User Stories\n`;
             if (data.userStory && data.userStory.length > 0 && !(data.userStory.length === 1 && data.userStory[0] === 'N/A')) {
                  data.userStory.forEach((story, index) => {
                     prd += `**US${index + 1}:** As a ${story || '[User Type N/A]'}, I want to ${data.userGoal?.[index] || '[Goal N/A]'}, so that ${data.userBenefit?.[index] || '[Benefit N/A]'}.\n`;
                 });
             } else { prd += `- N/A\n`; }
             prd += `\n### 2.4 Business Objectives\n${buildList(data.businessObjective)}\n\n`;
             prd += `### 2.5 Success Metrics\n${buildPairedList(data.metricName, data.metricTarget, '', 'Target')}\n\n`;
             prd += `---\n## 3. Features & Requirements\n\n`;
             prd += `### 3.1 Core Features\n`;
              if (data.featureName && data.featureName.length > 0 && !(data.featureName.length === 1 && data.featureName[0] === 'N/A')) {
                 data.featureName.forEach((feature, index) => {
                     prd += `**F${index + 1}: ${feature || 'N/A'}**\n`;
                     prd += `  - **Description:** ${data.featureDescription?.[index] || 'N/A'}\n`;
                     prd += `  - **Priority:** ${data.featurePriority?.[index] || 'Medium'}\n\n`;
                 });
             } else { prd += `- N/A\n\n`; }
             prd += `### 3.2 Future Features / Enhancements\n`;
             if (data.futureFeatureName && data.futureFeatureName.length > 0 && !(data.futureFeatureName.length === 1 && data.futureFeatureName[0] === 'N/A')) {
                  data.futureFeatureName.forEach((feature, index) => {
                     prd += `**FF${index + 1}: ${feature || 'N/A'}**\n`;
                     prd += `  - **Description:** ${data.futureFeatureDescription?.[index] || 'N/A'}\n\n`;
                 });
             } else { prd += `- N/A\n\n`; }
             prd += `### 3.3 Non-Functional Requirements (NFRs)\n${buildList(data.nfr.map(n => n.charAt(0).toUpperCase() + n.slice(1)))}\n\n`;
             prd += `---\n## 4. Technical Specifications\n\n`;
             prd += `### 4.1 Target Platforms\n${buildList(data.platforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)))}\n\n`;
             prd += `### 4.2 Technology Stack (Proposed/Preferred)\n${data.technologyStack}\n\n`;
             prd += `### 4.3 Integration Requirements\n`;
             if (data.integrationName && data.integrationName.length > 0 && !(data.integrationName.length === 1 && data.integrationName[0] === 'N/A')) {
                 data.integrationName.forEach((integration, index) => {
                     prd += `**INT${index + 1}: ${integration || 'N/A'}**\n`;
                     prd += `  - **Type:** ${data.integrationType?.[index] || 'N/A'}\n`;
                     prd += `  - **Purpose:** ${data.integrationPurpose?.[index] || 'N/A'}\n\n`;
                 });
             } else { prd += `- N/A\n\n`; }
             prd += `### 4.4 Technical Constraints\n${data.technicalConstraints}\n\n`;
             prd += `---\n## 5. Success Criteria & Timeline\n\n`;
             prd += `### 5.1 Project Timeline (Estimated)\n${data.projectTimeline}\n\n`;
             prd += `### 5.2 Target Launch Date (Estimated)\n${data.launchDate}\n\n`;
             prd += `### 5.3 Acceptance Criteria\n${buildList(data.acceptanceCriteria)}\n\n`;
             prd += `### 5.4 Risks & Mitigation Strategies\n`;
             if (data.riskDescription && data.riskDescription.length > 0 && !(data.riskDescription.length === 1 && data.riskDescription[0] === 'N/A')) {
                  data.riskDescription.forEach((risk, index) => {
                     prd += `**R${index + 1}: ${risk || 'N/A'}**\n`;
                     prd += `  - **Mitigation:** ${data.riskMitigation?.[index] || 'N/A'}\n\n`;
                 });
             } else { prd += `- N/A\n\n`; }
             prd += `---\n## 6. Additional Notes & Assumptions\n${data.additionalNotes}\n\n`;
             prd += `---\n**Document Owner:** (e.g., Product Management Team)\n`;
             prd += `**Key Stakeholders:** (e.g., Engineering Lead, Design Lead, QA Lead, Marketing Manager)\n`;
             prd += `**Generated by:** PRD Studio`;
             return prd;
        }

        const populateFormFromData = (draftData) => {
            gebi('prdForm').reset();
            clearAllDynamicLists();
            for (const key in draftData) {
                if (Array.isArray(draftData[key])) {
                    if (key === 'userStory') draftData[key].forEach((_, i) => addUserStory({ userStory: draftData.userStory[i], userGoal: draftData.userGoal?.[i], userBenefit: draftData.userBenefit?.[i] }));
                    else if (key === 'businessObjective') draftData[key].forEach(v => addBusinessObjective({ businessObjective: v }));
                    else if (key === 'metricName') draftData[key].forEach((_, i) => addSuccessMetric({ metricName: draftData.metricName[i], metricTarget: draftData.metricTarget?.[i] }));
                    else if (key === 'featureName') draftData[key].forEach((_, i) => addCoreFeature({ featureName: draftData.featureName[i], featureDescription: draftData.featureDescription?.[i], featurePriority: draftData.featurePriority?.[i] }));
                    else if (key === 'futureFeatureName') draftData[key].forEach((_, i) => addFutureFeature({ futureFeatureName: draftData.futureFeatureName[i], futureFeatureDescription: draftData.futureFeatureDescription?.[i] }));
                    else if (key === 'integrationName') draftData[key].forEach((_, i) => addIntegration({ integrationName: draftData.integrationName[i], integrationType: draftData.integrationType?.[i], integrationPurpose: draftData.integrationPurpose?.[i] }));
                    else if (key === 'acceptanceCriteria') draftData[key].forEach(v => addAcceptanceCriteria({ acceptanceCriteria: v }));
                    else if (key === 'riskDescription') draftData[key].forEach((_, i) => addRisk({ riskDescription: draftData.riskDescription[i], riskMitigation: draftData.riskMitigation?.[i] }));
                    else if (key === 'nfr' || key === 'platforms') {
                        document.querySelectorAll(`input[name="${key}[]"]`).forEach(chk => { chk.checked = draftData[key].includes(chk.value); });
                    }
                } else if (gebi(key)) {
                    gebi(key).value = draftData[key];
                }
            }
        };

        // --- Dynamic Item Management ---
        function createDynamicItem(contentHTML) {
            const newItem = document.createElement('div'); newItem.className = 'dynamic-item';
            newItem.innerHTML = `<div class="dynamic-item-content">${contentHTML}</div><button type="button" class="remove-btn" aria-label="Remove item" onclick="this.parentElement.remove()">√ó</button>`;
            return newItem;
        }
        function addDynamicItem(containerId, contentHTML, callbackFn) { const container = gebi(containerId); if (container) { const newItem = createDynamicItem(contentHTML); container.appendChild(newItem); if (callbackFn) callbackFn(newItem); } }
        window.addUserStory = (data = {}) => addDynamicItem('userStories', `<input type="text" class="form-input" value="${data.userStory || ''}" placeholder="As a [user type]..." name="userStory[]"><input type="text" class="form-input" value="${data.userGoal || ''}" placeholder="I want to [goal]..." name="userGoal[]"><input type="text" class="form-input" value="${data.userBenefit || ''}" placeholder="So that [benefit]..." name="userBenefit[]">`);
        window.addBusinessObjective = (data = {}) => addDynamicItem('businessObjectives', `<input type="text" class="form-input" value="${data.businessObjective || ''}" placeholder="Enter business objective" name="businessObjective[]">`);
        window.addSuccessMetric = (data = {}) => addDynamicItem('successMetrics', `<input type="text" class="form-input" value="${data.metricName || ''}" placeholder="Metric name" name="metricName[]"><input type="text" class="form-input" value="${data.metricTarget || ''}" placeholder="Target value" name="metricTarget[]">`);
        window.addCoreFeature = (data = {}) => addDynamicItem('coreFeatures', `<input type="text" class="form-input" value="${data.featureName || ''}" placeholder="Feature name" name="featureName[]"><textarea class="form-input form-textarea" placeholder="Feature description" name="featureDescription[]">${data.featureDescription || ''}</textarea><label class="form-label">Priority</label><div class="priority-grid"><div class="priority-option ${data.featurePriority === 'high' ? 'selected' : ''}" data-priority="high">High Priority</div><div class="priority-option ${!data.featurePriority || data.featurePriority === 'medium' ? 'selected' : ''}" data-priority="medium">Medium Priority</div><div class="priority-option ${data.featurePriority === 'low' ? 'selected' : ''}" data-priority="low">Low Priority</div></div><input type="hidden" name="featurePriority[]" value="${data.featurePriority || 'medium'}">`, setupPrioritySelectorsForItem);
        window.setupPrioritySelectorsForItem = (item) => { const grid = item.querySelector('.priority-grid'); const opts = grid.querySelectorAll('.priority-option'); const input = item.querySelector('input[type="hidden"]'); opts.forEach(opt => opt.onclick = () => { opts.forEach(o => o.classList.remove('selected')); opt.classList.add('selected'); input.value = opt.dataset.priority; }); };
        window.addFutureFeature = (data = {}) => addDynamicItem('futureFeatures', `<input type="text" class="form-input" value="${data.futureFeatureName || ''}" placeholder="Future feature name" name="futureFeatureName[]"><textarea class="form-input form-textarea" placeholder="Feature description" name="futureFeatureDescription[]">${data.futureFeatureDescription || ''}</textarea>`);
        window.addIntegration = (data = {}) => addDynamicItem('integrations', `<input type="text" class="form-input" value="${data.integrationName || ''}" placeholder="System/Service name" name="integrationName[]"><input type="text" class="form-input" value="${data.integrationType || ''}" placeholder="Integration type" name="integrationType[]"><textarea class="form-input form-textarea" placeholder="Integration purpose" name="integrationPurpose[]">${data.integrationPurpose || ''}</textarea>`);
        window.addAcceptanceCriteria = (data = {}) => addDynamicItem('acceptanceCriteria', `<textarea class="form-input form-textarea" placeholder="Describe successful completion" name="acceptanceCriteria[]">${data.acceptanceCriteria || ''}</textarea>`);
        window.addRisk = (data = {}) => addDynamicItem('risks', `<input type="text" class="form-input" value="${data.riskDescription || ''}" placeholder="Risk description" name="riskDescription[]"><input type="text" class="form-input" value="${data.riskMitigation || ''}" placeholder="Mitigation strategy" name="riskMitigation[]">`);
        const clearAllDynamicLists = () => ['userStories', 'businessObjectives', 'successMetrics', 'coreFeatures', 'futureFeatures', 'integrations', 'acceptanceCriteria', 'risks'].forEach(id => { gebi(id).innerHTML = ''; });
        const initializeDefaultDynamicItems = () => {
            const itemMap = { 'userStories': 'addUserStory', 'businessObjectives': 'addBusinessObjective', 'successMetrics': 'addSuccessMetric', 'coreFeatures': 'addCoreFeature', 'futureFeatures': 'addFutureFeature', 'integrations': 'addIntegration', 'acceptanceCriteria': 'addAcceptanceCriteria', 'risks': 'addRisk' };
            for (const containerId in itemMap) {
                if (gebi(containerId) && gebi(containerId).children.length === 0) {
                    const functionName = itemMap[containerId];
                    if (typeof window[functionName] === 'function') { window[functionName](); }
                }
            }
        };

        // --- Navigation ---
        const updateNavigation = () => { gebi('prevBtn').disabled = currentSection === 1; gebi('nextBtn').style.display = currentSection === totalSections ? 'none' : 'inline-flex'; gebi('generateBtn').style.display = currentSection === totalSections ? 'inline-flex' : 'none'; };
        const showSection = (sectionNumber) => { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); const el = document.querySelector(`[data-section="${sectionNumber}"]`); if (el) el.classList.add('active'); document.querySelectorAll('.step').forEach(step => { step.classList.remove('active', 'completed', 'inactive'); if (parseInt(step.dataset.step) < sectionNumber) step.classList.add('completed'); else if (parseInt(step.dataset.step) === sectionNumber) step.classList.add('active'); else step.classList.add('inactive'); }); updateNavigation(); window.scrollTo({ top: gebi('prdForm').offsetTop - 20, behavior: 'smooth' }); };
        window.nextSection = () => { if (currentSection < totalSections) { currentSection++; showSection(currentSection); } }
        window.previousSection = () => { if (currentSection > 1) { currentSection--; showSection(currentSection); } }
        window.navigateToSection = (sectionNumber) => { currentSection = sectionNumber; showSection(currentSection); }
        
        // --- API Handlers ---
        window.handleSaveDraft = () => { const apiUrl = getApiUrl(); if (apiUrl) { showModal('saveDraftModal'); gebi('draftNameInput').value = gebi('productName').value || `Draft ${new Date().toLocaleDateString()}`; } }
        window.confirmSaveDraft = async () => {
            const apiUrl = getApiUrl(); if (!apiUrl) return;
            const draftName = gebi('draftNameInput').value.trim(); if (!draftName) return showAppMessage("Draft name cannot be empty.", "error");
            showModalSpinner("Saving draft...");
            const payload = { action: 'saveDraft', fileName: draftName, data: getFormDataObject() };
            try {
                const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload), redirect: 'follow', headers: {'Content-Type': 'application/json'} });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                hideModal('saveDraftModal'); showAppMessage(`Draft "${draftName}" saved successfully!`, "success");
            } catch (error) { showAppMessage(`Error saving draft: ${error.message}`, "error"); }
            hideModalSpinner();
        }
        window.showLoadDraftModal = async () => {
            const apiUrl = getApiUrl(); if (!apiUrl) return;
            showModal('loadDraftModal');
            const listContainer = gebi('draftsListContainer'), noDraftsMsg = gebi('noDraftsMessage');
            listContainer.innerHTML = '<p>Loading drafts...</p>'; noDraftsMsg.style.display = 'none';
            try {
                const response = await fetch(`${apiUrl}?action=listDrafts`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                if (!result.drafts || result.drafts.length === 0) { listContainer.innerHTML = ''; noDraftsMsg.style.display = 'block'; return; }
                listContainer.innerHTML = '';
                result.drafts.forEach(draft => {
                    const item = document.createElement('div');
                    item.className = 'drafts-list-item';
                    item.innerHTML = `<span>${draft.name}</span><div><button class="btn btn-sm btn-primary" style="padding:4px 8px;font-size:12px;margin-right:5px;">Load</button><button class="draft-delete-btn">Delete</button></div>`;
                    item.querySelector('.btn-primary').onclick = () => loadSelectedDraft(draft.id);
                    item.querySelector('.draft-delete-btn').onclick = (e) => { e.stopPropagation(); confirmDeleteDraft(draft.id, draft.name); };
                    listContainer.appendChild(item);
                });
            } catch (error) { listContainer.innerHTML = '<p>Error loading drafts.</p>'; showAppMessage(`Error: ${error.message}`, "error"); }
        }
        async function loadSelectedDraft(fileId) {
            const apiUrl = getApiUrl(); if (!apiUrl) return;
            showModalSpinner(`Loading draft...`); hideModal('loadDraftModal');
            try {
                const response = await fetch(`${apiUrl}?action=loadDraft&fileId=${fileId}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                populateFormFromData(result.data);
                showAppMessage(`Draft loaded successfully.`, "success");
            } catch (error) { showAppMessage(`Error loading draft: ${error.message}`, "error"); }
            hideModalSpinner();
        }
        function confirmDeleteDraft(fileId, fileName) { if (confirm(`Are you sure you want to delete the draft "${fileName}"?`)) { deleteSelectedDraft(fileId); } }
        async function deleteSelectedDraft(fileId) {
            const apiUrl = getApiUrl(); if (!apiUrl) return;
            showModalSpinner(`Deleting draft...`);
            const payload = { action: 'deleteDraft', fileId: fileId };
            try {
                const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload), redirect: 'follow', headers: {'Content-Type': 'application/json'} });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                showAppMessage(`Draft deleted.`, "success");
                await showLoadDraftModal(); // Refresh list inside the modal
            } catch (error) { showAppMessage(`Error deleting draft: ${error.message}`, "error"); }
            hideModalSpinner();
        }
        window.handleSaveFinal = async () => {
            const apiUrl = getApiUrl(); if (!apiUrl) return;
            const finalName = gebi('productName').value.trim() || `Final-PRD-${Date.now()}`;
            if (!confirm(`This will save a final PDF named "${finalName}.pdf" to your Google Drive. Continue?`)) return;
            showModalSpinner("Saving final PDF to Google Drive...");
            const payload = { action: 'saveFinalPdf', fileName: finalName, markdown: createPRDMarkdown() };
            try {
                const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload), redirect: 'follow', headers: {'Content-Type': 'application/json'} });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                showAppMessage(`Final PDF saved to Google Drive!`, "success");
            } catch (error) { showAppMessage(`Error saving final PDF: ${error.message}`, "error"); }
            hideModalSpinner();
        }

        // Modal helpers
        window.showModal = (modalId) => gebi(modalId).classList.add('active');
        window.hideModal = (modalId) => gebi(modalId).classList.remove('active');
        const showModalSpinner = (text = "Processing...") => { gebi('loadingSpinnerText').textContent = text; showModal('loadingSpinnerModal'); }
        const hideModalSpinner = () => hideModal('loadingSpinnerModal');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            gebi('currentYear').textContent = new Date().getFullYear();
            initializeDefaultDynamicItems(); 
            updateNavigation();
            showSection(currentSection); 
        });
    </script>
</body>
</html>
