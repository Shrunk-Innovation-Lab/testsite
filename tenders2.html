<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tender Evaluation Dashboard</title>
  <link rel="icon" href="https://i.imgur.com/dZR7M8C.png" type="image/png" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: [
              'ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Inter','Helvetica Neue','Arial','Noto Sans','Apple Color Emoji','Segoe UI Emoji'
            ]
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' }
        }
      }
    }
  </script>
  <!-- React 18 + Babel for JSX (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Papa Parse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Apache ECharts (UMD) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900 min-h-screen font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    /* ===================== API model & placeholders ===================== */
    // Locked model per your instruction
    window.WASTEYE_OPENAI_MODEL = 'gpt-4o-mini';
    // Local-only placeholder for key/base (kept blank by default for safety). Do NOT commit secrets.
    window.WASTEYE_OPENAI_URL = 'https://api.openai.com/v1';
    window.WASTEYE_OPENAI_KEY = window.WASTEYE_OPENAI_KEY || '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';

    /* ===================== Utilities (ES5-safe) ===================== */
    function isDefined(v){ return !(v === undefined || v === null); }
    function safeLocale(n, opts){
      if (typeof n === 'number' && !isNaN(n) && n !== null && n !== undefined && n.toLocaleString) {
        return n.toLocaleString(undefined, opts || {});
      }
      return String(n);
    }
    function numberify(v){
      if (v === null || v === undefined) return null;
      var s = String(v).replace(/[$£€,%\s]/g, '');
      var n = parseFloat(s);
      return isNaN(n) ? null : n;
    }
    function uniqueSorted(arr){
      return Array.from(new Set(arr.filter(function(v){ return v !== '' && v !== null && v !== undefined; })))
        .sort(function(a,b){ return String(a).localeCompare(String(b)); });
    }
    function downloadCSV(rows, filename){
      if (!filename) filename = 'export.csv';
      var csv = Papa.unparse(rows);
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.href = url; link.download = filename; link.click();
      URL.revokeObjectURL(url);
    }

    /* ===================== Fixed Column Headings ===================== */
    var FIXED_HEADERS = [
      'State',
      'Site Name',
      'Service Description',
      'Service Type',
      'Waste Stream',
      'Bin Size',
      'UoM',
      'QTY',
      'Frequency',
      'Mon',
      'Tue',
      'Wed',
      'Thu',
      'Fri',
      'Sat',
      'Sun',
      'Average Collected',
      'Frequency',
      'Collections Per Annum',
      'Average Density',
      'Current EA Rate',
      'Current Annual Cost',
      'Notes'
    ];

    /* ===================== Mapping (Filters use real names; H vs Q analytics) ===================== */
    var MAPPING = {
      // First five filters: State, Site Name, Service Description, Service Type, Waste Stream
      filterCols: [0,1,2,3,4],
      // Analytics default: Tender(H) = QTY (H=7), Actual(Q) = Average Collected (Q=16)
      tenderValueCol: 7,   // H
      actualAvgCol: 16     // Q
    };

    /* ===================== Components ===================== */
    function MultiSelect(props){
      const [open, setOpen] = useState(false);
      const ref = useRef(null);
      useEffect(function(){
        function handler(e){ if (ref.current && !ref.current.contains(e.target)) setOpen(false); }
        document.addEventListener('click', handler);
        return function(){ document.removeEventListener('click', handler); };
      },[]);
      return (
        <div className="relative" ref={ref}>
          <label className="block text-xs uppercase tracking-wide opacity-70 mb-1">{props.label}</label>
          <button onClick={function(){ setOpen(!open); }} className="w-full glass border border-slate-200/60 rounded-2xl px-3 py-2 text-left shadow-soft">
            <div className="flex flex-wrap gap-1 min-h-[1.5rem]">
              {props.selected.length === 0 && <span className="opacity-50">All</span>}
              {props.selected.map(function(v){
                return (
                  <span key={v} className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs bg-slate-900/5">
                    {v}
                    <button className="opacity-60 hover:opacity-100" onClick={function(){ props.onChange(props.selected.filter(function(s){return s!==v;})); }} title="Remove">✕</button>
                  </span>
                );
              })}
            </div>
          </button>
          {open && (
            <div className="absolute z-20 mt-2 max-h-64 overflow-auto w-full glass border border-slate-200/60 rounded-md p-2 shadow-soft">
              <div className="flex items-center justify-between mb-2">
                <button className="text-xs underline" onClick={function(){ props.onChange([]); }}>Select none</button>
                <button className="text-xs underline" onClick={function(){ props.onChange([].concat(props.options)); }}>Select all</button>
              </div>
              <ul className="space-y-1">
                {props.options.map(function(opt){
                  return (
                    <li key={opt}>
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" className="accent-slate-900" checked={props.selected.includes(opt)} onChange={function(e){
                          if (e.target.checked) props.onChange([].concat(props.selected, [opt]));
                          else props.onChange(props.selected.filter(function(v){ return v!==opt; }));
                        }} />
                        <span>{opt}</span>
                      </label>
                    </li>
                  );
                })}
              </ul>
            </div>
          )}
        </div>
      );
    }

    function DataTable(props){
      const [page, setPage] = useState(1);
      const pageSize = 50;
      const totalPages = Math.max(1, Math.ceil(props.rows.length / pageSize));
      const view = props.rows.slice((page-1)*pageSize, page*pageSize);
      useEffect(function(){ setPage(1); }, [props.rows]);
      return (
        <div className="glass rounded-md border border-slate-200/60">
          <div className="overflow-x-auto rounded-md">
            <table className="min-w-full text-sm border border-slate-200" style={{borderCollapse:'collapse'}}>
              <thead className="bg-slate-900/5">
                <tr>
                  {props.headers.map(function(h,i){ return <th key={i} className="text-left px-4 py-2 whitespace-nowrap border border-slate-200">{h || ('Column ' + String.fromCharCode(65+i))}</th>; })}
                </tr>
              </thead>
              <tbody>
                {view.map(function(row, ri){
                  return (
                    <tr key={ri} className="odd:bg-white/40 even:bg-white/20">
                      {row.map(function(cell,ci){ return <td key={ci} className="px-4 py-2 whitespace-nowrap border border-slate-200">{String(cell)}</td>; })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div className="flex items-center justify-between p-3 text-xs">
            <span>Page {page} of {totalPages}</span>
            <div className="flex items-center gap-2">
              <button className="px-3 py-1 rounded-xl border border-slate-300" disabled={page===1} onClick={function(){ setPage(function(p){ return Math.max(1,p-1); }); }}>Previous</button>
              <button className="px-3 py-1 rounded-xl border border-slate-300" disabled={page===totalPages} onClick={function(){ setPage(function(p){ return Math.min(totalPages,p+1); }); }}>Next</button>
            </div>
          </div>
        </div>
      );
    }

    function EChart(props){
      const ref = useRef(null);
      useEffect(function(){
        if (!window.echarts || !ref.current) return;
        var chart = echarts.init(ref.current);
        chart.setOption(props.option);
        function onResize(){ chart.resize(); }
        window.addEventListener('resize', onResize);
        return function(){ window.removeEventListener('resize', onResize); chart.dispose(); };
      }, [props.option]);
      return <div ref={ref} className={props.className || 'h-[68vh]'} />;
    }

    /* ===================== App ===================== */
    function App(){
      const [navOpen, setNavOpen] = useState(true);
      const [headers, setHeaders] = useState(FIXED_HEADERS.slice());
      const [rawRows, setRawRows] = useState([]);
      const [filters, setFilters] = useState([[],[],[],[],[]]);
      const [search, setSearch] = useState('');

      // Diagnostics tests (silent)
      const tests = useMemo(function(){
        var results = [];
        results.push({ name: 'Charts library available (echarts)', pass: !!window.echarts });
        results.push({ name: 'numberify parses currency', pass: numberify('$1,234.50') === 1234.5 });
        var mini = [['A','B'], ['r1','x'], ['r2','y']];
        var selected = ['x'];
        var filtered = mini.slice(1).filter(function(r){ return selected.length===0 || selected.includes(r[1]); });
        results.push({ name: 'filter includes only selected', pass: filtered.length === 1 && filtered[0][0] === 'r1' });
        var csvOk = Papa.parse('col1,col2\n1,2').data.length === 2;
        results.push({ name: 'CSV parser basic', pass: csvOk });
        results.push({ name: 'uniqueSorted dedups & sorts', pass: JSON.stringify(uniqueSorted(['b','a','a'])) === JSON.stringify(['a','b']) });
        results.push({ name: 'numberify strips spaces/%', pass: numberify('1 234.0%') === 1234.0 });
        var testHeaders = ['State','Site Name','X'];
        var tIdx = (function(h){ var idx=-1; for (var i=0;i<h.length;i++){ var a=String(h[i]||'').toLowerCase(); if(a==='site name'){ idx=i; break; } } if(idx===-1) idx=1; return idx; })(testHeaders);
        results.push({ name: 'group index prefers Site Name', pass: tIdx === 1 });
        var searchPass = (function(){ var rows=[["alpha"],["beta"],["gamma"]]; var q='bet'; var out = rows.filter(function(r){ return String(r[0]).toLowerCase().indexOf(q) !== -1; }); return out.length===1 && out[0][0]==='beta'; })();
        results.push({ name: 'search substring filters correctly', pass: searchPass });
        var sim = [['Scope Preparation'], ['State','Site Name','Service Description'], ['NSW','Alpha','Wheelie']];
        var norm = applyHeaderOverride(sim);
        results.push({ name: 'header detection strips header line', pass: norm.dataRows.length===1 && norm.dataRows[0][0]==='NSW' });
        results.push({ name: 'scatter good/watch split', pass: (function(){ var data=[{x:3,y:2},{x:1,y:4}]; return data.filter(function(p){return p.x>=p.y;}).length===1; })() });
        results.push({ name: 'diagonal min<max', pass: (function(){ var xs=[1,2], ys=[2,3]; var min=Math.min.apply(null,xs.concat(ys)); var max=Math.max.apply(null,xs.concat(ys)); return min<max; })() });
        return results;
      }, []);

      // Normalize rows to fixed headers & strip incoming header row if present
      function applyHeaderOverride(rows){
        function normalizeHeader(s){ return String(s||'').replace(/^\uFEFF/, '').trim().toLowerCase(); }
        function headerMatchCount(row){
          var count = 0; var lim = Math.min(row.length, FIXED_HEADERS.length);
          for (var i=0;i<lim;i++) if (normalizeHeader(row[i]) === normalizeHeader(FIXED_HEADERS[i])) count++;
          return count;
        }
        function findHeaderIndex(all){
          var maxLook = Math.min(6, all.length);
          for (var i=0;i<maxLook;i++){
            var row = all[i] || [];
            var nonEmpty = row.filter(function(x){ return String(x||'').trim()!==''; });
            if (nonEmpty.length <= 1) continue; // skip title rows like "Scope Preparation"
            var tokens = row.map(normalizeHeader);
            var incState = tokens.indexOf('state') !== -1;
            var incSite = tokens.indexOf('site name') !== -1;
            var matches = headerMatchCount(row);
            if ((incState && incSite) || matches >= 3) return i;
          }
          return -1;
        }
        var headerIdx = findHeaderIndex(rows);
        var data = (headerIdx >= 0) ? rows.slice(headerIdx + 1) : rows.slice();
        data = data.filter(function(r){ return r && r.some(function(c){ return String(c||'').trim()!==''; }); });
        var targetLen = FIXED_HEADERS.length;
        var dataRows = data.map(function(r){
          var copy = r.slice(0, targetLen);
          while (copy.length < targetLen) copy.push('');
          return copy;
        });
        return { dataRows: dataRows };
      }

      // Auto-load data.csv if present
      useEffect(function(){
        fetch('data.csv', { cache: 'no-store' })
          .then(function(res){ return res.ok ? res.text() : Promise.reject('no file'); })
          .then(function(text){ return Papa.parse(text, { header: false }); })
          .then(function(result){
            if (result && result.data && result.data.length){
              var rows = result.data.filter(function(r){ return r && r.length; });
              var out = applyHeaderOverride(rows);
              setHeaders(FIXED_HEADERS);
              setRawRows(out.dataRows);
            }
          }).catch(function(){ /* ignore missing file */ });
      }, []);

      // Upload
      function onUpload(file){
        Papa.parse(file, {
          header: false,
          complete: function(res){
            var rows = res.data.filter(function(r){ return r && r.length; });
            var out = applyHeaderOverride(rows);
            setHeaders(FIXED_HEADERS);
            setRawRows(out.dataRows);
          }
        });
      }

      // Filter options & apply filters
      const filterOptions = useMemo(function(){
        return MAPPING.filterCols.map(function(colIdx){ return uniqueSorted(rawRows.map(function(r){ return r[colIdx]; })); });
      }, [rawRows]);

      const filteredRows = useMemo(function(){
        return rawRows.filter(function(r){
          return MAPPING.filterCols.every(function(colIdx, i){
            var sel = filters[i];
            if (!sel || sel.length === 0) return true;
            return sel.includes(r[colIdx]);
          });
        });
      }, [rawRows, filters]);

      // Global table search
      const searchedRows = useMemo(function(){
        var q = (search || '').toLowerCase().trim();
        if (!q) return filteredRows;
        return filteredRows.filter(function(r){
          for (var i=0;i<r.length;i++){
            var cell = r[i];
            if (cell !== null && cell !== undefined && String(cell).toLowerCase().indexOf(q) !== -1) return true;
          }
          return false;
        });
      }, [filteredRows, search]);

      // Metrics
      const metrics = useMemo(function(){
        var tv = filteredRows.map(function(r){ return numberify(r[MAPPING.tenderValueCol]); }).filter(function(v){ return v !== null; });
        var aa = filteredRows.map(function(r){ return numberify(r[MAPPING.actualAvgCol]); }).filter(function(v){ return v !== null; });
        var avg = function(arr){ return arr.length ? arr.reduce(function(a,b){return a+b;},0)/arr.length : 0; };
        var min = function(arr){ return arr.length ? Math.min.apply(null, arr) : 0; };
        var max = function(arr){ return arr.length ? Math.max.apply(null, arr) : 0; };
        return {
          count: filteredRows.length,
          tenderAvg: avg(tv), tenderMin: min(tv), tenderMax: max(tv),
          actualAvg: avg(aa), actualMin: min(aa), actualMax: max(aa),
          deltaAvg: avg(tv) - avg(aa)
        };
      }, [filteredRows]);

      // Grouping: default to Site Name; fallback to column B
      const groupLabelIdx = useMemo(function(){
        var idx = -1;
        for (var i=0; i<headers.length; i++){
          var h = String(headers[i] || '').toLowerCase();
          if (h === 'site name') { idx = i; break; }
        }
        if (idx === -1) idx = 1; // column B fallback
        return idx;
      }, [headers]);

      const grouped = useMemo(function(){
        var g = new Map();
        filteredRows.forEach(function(r){
          var label = isDefined(r[groupLabelIdx]) ? r[groupLabelIdx] : '—';
          var tv = numberify(r[MAPPING.tenderValueCol]);
          var aa = numberify(r[MAPPING.actualAvgCol]);
          if (!g.has(label)) g.set(label, { label: label, tvs: [], aas: [] });
          if (tv !== null) g.get(label).tvs.push(tv);
          if (aa !== null) g.get(label).aas.push(aa);
        });
        return Array.from(g.values()).map(function(x){
          return {
            label: x.label,
            tender: x.tvs.length ? x.tvs.reduce(function(a,b){return a+b;},0)/x.tvs.length : 0,
            actual: x.aas.length ? x.aas.reduce(function(a,b){return a+b;},0)/x.aas.length : 0
          };
        }).sort(function(a,b){ return String(a.label).localeCompare(String(b.label)); });
      }, [filteredRows, groupLabelIdx]);

      // Scatter H vs Q
      const scatter = useMemo(function(){
        return filteredRows.map(function(r){
          return { x: numberify(r[MAPPING.tenderValueCol]), y: numberify(r[MAPPING.actualAvgCol]), label: r[groupLabelIdx] };
        }).filter(function(p){ return p.x !== null && p.y !== null; });
      }, [filteredRows, groupLabelIdx]);

      // Export
      function exportFiltered(){ downloadCSV([headers].concat(filteredRows), 'tenders_filtered.csv'); }

      // Expose for AI
      useEffect(function(){ window.__TENDER_STATE__ = { headers: headers, filteredRows: filteredRows }; }, [headers, filteredRows]);

      // Chart options
      const barOption = useMemo(function(){ return ({
        tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
        legend: { data: ['Tender (H)', 'Actual (Q)'] },
        grid: { left: 220, right: 40, top: 30, bottom: 40 },
        xAxis: { type: 'value' },
        yAxis: {
          type: 'category',
          data: grouped.map(function(d){ return d.label; }),
          axisLabel: { interval: 0, fontSize: 12, width: 220, overflow: 'truncate' }
        },
        dataZoom: [ { type: 'slider', yAxisIndex: 0, start: 0, end: 100, width: 14, right: 6 }, { type: 'inside', yAxisIndex: 0, start: 0, end: 100 } ],
        series: [
          { type: 'bar', name: 'Tender (H)', data: grouped.map(function(d){ return d.tender; }), barMaxWidth: 18 },
          { type: 'bar', name: 'Actual (Q)', data: grouped.map(function(d){ return d.actual; }), barMaxWidth: 18 }
        ]
      }); }, [grouped]);

      const scatterOption = useMemo(function(){ 
        var xs = scatter.map(function(p){ return p.x; });
        var ys = scatter.map(function(p){ return p.y; });
        var minVal = 0, maxVal = 1;
        if (xs.length || ys.length){
          var localMin = Math.min.apply(null, xs.concat(ys));
          var localMax = Math.max.apply(null, xs.concat(ys));
          var pad = (localMax - localMin) * 0.05;
          minVal = Math.max(0, localMin - pad);
          maxVal = localMax + pad;
          if (!isFinite(minVal)) minVal = 0;
          if (!isFinite(maxVal) || maxVal <= minVal) maxVal = minVal + 1;
        }
        var good = [], watch = [];
        for (var i=0;i<scatter.length;i++){
          var p = scatter[i];
          var datum = { name: String(isDefined(p.label) ? p.label : ''), value: [p.x, p.y] };
          if (p.x >= p.y) good.push(datum); else watch.push(datum);
        }
        return ({
          tooltip: { trigger: 'item', formatter: function(p){
            var xv = (p.value && isDefined(p.value[0])) ? p.value[0] : (p.data && isDefined(p.data.x) ? p.data.x : '');
            var yv = (p.value && isDefined(p.value[1])) ? p.value[1] : (p.data && isDefined(p.data.y) ? p.data.y : '');
            var xStr = (xv && xv.toLocaleString) ? xv.toLocaleString() : xv;
            var yStr = (yv && yv.toLocaleString) ? yv.toLocaleString() : yv;
            var nm = p.name || 'Row';
            var tag = (xv >= yv) ? 'Good (H ≥ Q)' : 'Watch (Q > H)';
            return nm + '<br/>H: ' + xStr + '<br/>Q: ' + yStr + '<br/>' + tag;
          }},
          grid: { left: 50, right: 20, top: 30, bottom: 40 },
          legend: { data: ['H = Q','Good (H ≥ Q)','Watch (Q > H)'] },
          xAxis: { name: 'Tender (H)', type: 'value', min: minVal, max: maxVal },
          yAxis: { name: 'Actual (Q)', type: 'value', min: minVal, max: maxVal },
          series: [
            { type: 'line', name: 'H = Q', data: [[minVal, minVal], [maxVal, maxVal]], showSymbol: false, silent: true, tooltip: { show: false },
              lineStyle: { type: 'dashed', width: 1 } },
            { type: 'scatter', name: 'Good (H ≥ Q)', data: good, itemStyle: { color: '#10B981' } },
            { type: 'scatter', name: 'Watch (Q > H)', data: watch, itemStyle: { color: '#EF4444' } }
          ]
        });
      }, [scatter]);

      /* ===================== Render ===================== */
      return (
        <>
          {!navOpen && (
            <button
              onClick={function(){ setNavOpen(true); }}
              className="fixed z-50 px-3 py-2 rounded-2xl glass border border-slate-200/60 shadow-soft text-sm
                         top-20 right-4 sm:right-6 md:right-8 lg:right-[calc((100vw-1600px)/2+1rem)] xl:right-[calc((100vw-1800px)/2+1rem)]"
              aria-label="Show sidebar" title="Show sidebar"
            >
              ☰ Filters
            </button>
          )}
          <div className="w-full max-w-[1600px] xl:max-w-[1800px] mx-auto p-4 md:p-8">
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              {navOpen && (
                <aside className="lg:col-span-3 space-y-4">
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft sticky top-4">
                    <div className="flex items-center justify-between mb-1">
                      <h2 className="text-lg font-semibold">Filters</h2>
                      <button onClick={function(){ setNavOpen(false); }} className="text-xs px-2 py-1 rounded-xl border border-slate-200/60 hover:bg-slate-900/5" title="Hide sidebar">Hide</button>
                    </div>
                    <nav className="space-y-1 text-sm mb-4">
                      <a href="#overview" className="block px-3 py-2 rounded-2xl hover:bg-slate-900/5">Overview</a>
                      <a href="#charts" className="block px-3 py-2 rounded-2xl hover:bg-slate-900/5">Charts</a>
                      <a href="#table" className="block px-3 py-2 rounded-2xl hover:bg-slate-900/5">Table</a>
                      <a href="#ai" className="block px-3 py-2 rounded-2xl hover:bg-slate-900/5">AI Feedback</a>
                    </nav>

                    <label className="inline-flex items-center justify-center gap-2 text-sm glass px-3 py-2 rounded-2xl border border-slate-200/60 cursor-pointer w-full">
                      <input type="file" accept=".csv" className="hidden" onChange={function(e){ if (e.target.files && e.target.files[0]) onUpload(e.target.files[0]); }} />
                      <span>Upload CSV</span>
                    </label>
                    <button className="mt-2 px-3 py-2 rounded-2xl bg-slate-900 text-white shadow-soft w-full" onClick={exportFiltered}>Export (CSV)</button>

                    <div className="mt-4 space-y-3">
                      {MAPPING.filterCols.slice(0,5).map(function(colIdx, i){
                        return (
                          <MultiSelect
                            key={i}
                            label={headers[colIdx] || ('Column ' + String.fromCharCode(65+i))}
                            options={filterOptions[i] || []}
                            selected={filters[i]}
                            onChange={function(vals){ var next = filters.slice(); next[i] = vals; setFilters(next); }}
                          />
                        );
                      })}
                    </div>
                  </div>
                </aside>
              )}

              <main className={(navOpen ? 'lg:col-span-9 ' : 'lg:col-span-12 ') + 'space-y-6'}>
                <section id="overview" className="space-y-1">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <img src="https://i.imgur.com/iB983sa.png" alt="Logo" className="h-8 w-auto" />
                      <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Tender Evaluation Dashboard</h1>
                    </div>
                  </div>
                  <p className="opacity-70">Use the filters to refine the view.</p>
                </section>

                <section className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="text-xs opacity-70">Records</div>
                    <div className="text-2xl font-semibold">{metrics.count}</div>
                  </div>
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="text-xs opacity-70">Tender Avg (H)</div>
                    <div className="text-2xl font-semibold">{safeLocale(metrics.tenderAvg, { maximumFractionDigits: 2 })}</div>
                    <div className="text-xs opacity-70">Min {safeLocale(metrics.tenderMin)} · Max {safeLocale(metrics.tenderMax)}</div>
                  </div>
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="text-xs opacity-70">Actual Avg (Q)</div>
                    <div className="text-2xl font-semibold">{safeLocale(metrics.actualAvg, { maximumFractionDigits: 2 })}</div>
                    <div className="text-xs opacity-70">Min {safeLocale(metrics.actualMin)} · Max {safeLocale(metrics.actualMax)}</div>
                  </div>
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="text-xs opacity-70">Δ Avg (H − Q)</div>
                    <div className={'text-2xl font-semibold ' + (metrics.deltaAvg>=0?'text-emerald-600':'text-rose-600')}>{safeLocale(metrics.deltaAvg, { maximumFractionDigits: 2 })}</div>
                    <div className="text-xs opacity-70">Positive = higher tender than actual</div>
                  </div>
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft col-span-1 md:col-span-2">
                    <div className="text-xs opacity-70 mb-2">BAFO Helper</div>
                    <p className="text-sm opacity-80">Filter your shortlist, then <strong>Export</strong> to share for BAFO.</p>
                  </div>
                </section>

                <section id="charts" className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="font-semibold">Avg Tender vs Actual — by Site</h3>
                      <span className="text-xs opacity-70">Grouped by Site Name</span>
                    </div>
                    <EChart option={barOption} className="h-[68vh]" />
                    <p className="text-xs opacity-70 mt-2">Compares average <strong>Tender (H)</strong> vs <strong>Actual (Q)</strong> for each Site.
                      <strong> Good</strong>: Tender ≥ Actual (room to negotiate/BAFO).
                      <strong> Watch</strong>: Actual &gt; Tender (risk of underquoted scope or higher-than-expected usage).</p>
                  </div>
                  <div className="glass rounded-md p-4 border border-slate-200/60 shadow-soft">
                    <div className="flex items-center justify-between mb-2">
                      <h3 className="font-semibold">Tender (H) vs Actual (Q) — Scatter</h3>
                    </div>
                    <EChart option={scatterOption} className="h-[68vh]" />
                    <p className="text-xs opacity-70 mt-2">Each point is a row (site/service). The diagonal line is <em>H = Q</em>.
                      <strong> Good</strong>: points <em>below</em> the line (H &gt; Q).
                      <strong> Watch</strong>: points <em>above</em> the line (Q &gt; H).</p>
                  </div>
                </section>

                <section id="table" className="space-y-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm opacity-70">Showing {searchedRows.length} of {filteredRows.length} filtered rows</div>
                    <div className="flex items-center gap-2">
                      <input value={search} onChange={function(e){ setSearch(e.target.value); }}
                        placeholder="Search table…" className="glass border border-slate-200/60 rounded-2xl px-3 py-2 text-sm min-w-[18rem]" />
                      {search && (
                        <button onClick={function(){ setSearch(''); }} className="text-xs px-2 py-1 rounded-xl border border-slate-200/60 hover:bg-slate-900/5">Clear</button>
                      )}
                    </div>
                  </div>
                  <DataTable headers={headers} rows={searchedRows} />
                </section>

                <section id="ai" className="glass rounded-md p-4 border border-slate-200/60 space-y-4">
                  <h3 className="font-medium">WastEye AI Feedback</h3>
                  <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
                    <div className="lg:col-span-2 space-y-3">
                      <div>
                        <label className="block text-xs uppercase tracking-wide opacity-70 mb-1">Question / Focus</label>
                        <textarea id="ai-question" className="w-full glass border border-slate-200/60 rounded-2xl p-3 h-24" placeholder="e.g., Identify outliers where Tender (H) materially exceeds Actual (Q), suggest BAFO targets by region." />
                      </div>
                      <div className="flex gap-2">
                        <button id="btn-local" className="px-3 py-2 rounded-2xl bg-slate-900 text-white shadow-soft">Run Quick (Local)</button>
                        <button id="btn-remote" className="px-3 py-2 rounded-2xl border border-slate-300 shadow-soft">Ask WastEye AI</button>
                      </div>
                    </div>
                    <div className="lg:col-span-3">
                      <div className="glass rounded-md p-3 border border-slate-200/60 h-full min-h-[12rem]">
                        <div className="text-xs uppercase tracking-wide opacity-70 mb-2">Response</div>
                        <div id="ai-output" className="prose prose-sm prose-slate max-w-none"><p className="opacity-70">No analysis yet. Choose a mode to generate insights.</p></div>
                      </div>
                    </div>
                  </div>
                </section>

                <div className="text-xs opacity-70 text-center py-6">2025 | Wasted by Shrunk</div>
              </main>
            </div>
          </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    /* ===================== AI Feedback wiring ===================== */
    function summarizeLocally(headers, rows){
      if (!rows.length) return 'No rows selected after filters. Add or relax filters and try again.';
      var H = 7, Q = 16;
      var values = rows.map(function(r){
        var grp = isDefined(r[1]) ? String(r[1]) : (isDefined(r[0]) ? String(r[0]) : '');
        return { h: numberify(r[H]), q: numberify(r[Q]), group: grp };
      }).filter(function(v){ return v.h !== null && v.q !== null; });
      var n = values.length;
      var avg = function(a){ return a.reduce(function(s,x){return s+x;},0)/a.length; };
      var byGroup = {};
      for (var i=0;i<values.length;i++){
        var v = values[i];
        if (!byGroup[v.group]) byGroup[v.group] = { h: [], q: [] };
        byGroup[v.group].h.push(v.h); byGroup[v.group].q.push(v.q);
      }
      var groups = Object.keys(byGroup).map(function(g){ var d = byGroup[g]; return { g: g, hAvg: avg(d.h), qAvg: avg(d.q), delta: avg(d.h) - avg(d.q) }; })
        .sort(function(a,b){ return Math.abs(b.delta) - Math.abs(a.delta); }).slice(0, 10);
      var overallH = avg(values.map(function(v){return v.h;}));
      var overallQ = avg(values.map(function(v){return v.q;}));
      var overallDelta = overallH - overallQ;
      var topOver = groups.filter(function(x){return x.delta>0;}).slice(0,5);
      var topUnder = groups.filter(function(x){return x.delta<0;}).slice(0,5);
      var md = '';
      md += '**Snapshot ('+n+' rows)**\n';
      md += '• Avg Tender (H): ' + safeLocale(overallH, {maximumFractionDigits:2}) + '\n';
      md += '• Avg Actual (Q): ' + safeLocale(overallQ, {maximumFractionDigits:2}) + '\n';
      md += '• Δ (H−Q): ' + safeLocale(overallDelta, {maximumFractionDigits:2}) + ' ' + (overallDelta>=0?'(tender above actual)':'(actual above tender)') + '\n\n';
      if (topOver.length) {
        md += '**Groups with Tender > Actual (largest deltas)**\n';
        for (var j=0;j<topOver.length;j++){
          var x = topOver[j];
          md += '• ' + x.g + ': Δ ' + safeLocale(x.delta, {maximumFractionDigits:2}) + ' (H ' + safeLocale(x.hAvg,{maximumFractionDigits:1}) + ' vs Q ' + safeLocale(x.qAvg,{maximumFractionDigits:1}) + ')\n';
        }
        md += '\n';
      }
      if (topUnder.length) {
        md += '**Groups with Actual ≥ Tender (largest negatives)**\n';
        for (var k=0;k<topUnder.length;k++){
          var x2 = topUnder[k];
          md += '• ' + x2.g + ': Δ ' + safeLocale(x2.delta, {maximumFractionDigits:2}) + ' (H ' + safeLocale(x2.hAvg,{maximumFractionDigits:1}) + ' vs Q ' + safeLocale(x2.qAvg,{maximumFractionDigits:1}) + ')\n';
        }
        md += '\n';
      }
      md += 'Tips: Use positive-Δ groups to negotiate BAFO reductions; investigate negatives for scope/quality assumptions.';
      return md;
    }

    function buildPrompt(headers, rows, question){
      var H = 7, Q = 16, maxRows = 120;
      var keys = headers.map(function(h,i){ return h || ('Column ' + String.fromCharCode(65+i)); });
      var sliced = rows.slice(0, maxRows);
      var payload = sliced.map(function(r){ return { A:r[0], B:r[1], C:r[2], D:r[3], E:r[4], H:r[H], Q:r[Q] }; });
      return 'You are an expert procurement analyst. The user has tender data with a fixed schema (named columns). Use tender value=H and actual average collected=Q. Analyze H vs Q for the provided filtered rows and answer the user\'s question. Be concise, bullet-pointed, and actionable for BAFO.' +
             '\n\nQuestion: ' + (question || 'Identify outliers and BAFO opportunities.') +
             '\n\nColumns: ' + JSON.stringify(keys) +
             '\nSample (first ' + sliced.length + ' rows):\n' + JSON.stringify(payload);
    }

    async function askWastEye(prompt){
      var base = window.WASTEYE_OPENAI_URL || 'https://api.openai.com/v1';
      var key = window.WASTEYE_OPENAI_KEY || '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';
      var model = window.WASTEYE_OPENAI_MODEL || 'gpt-4o-mini';
      if (!key) throw new Error('No OpenAI key found in code. Set window.WASTEYE_OPENAI_KEY locally for testing.');
      var url = base.replace(/\/$/,'') + '/chat/completions';
      var payload = { model: model, messages: [ { role: 'system', content: 'You are a concise, rigorous procurement analyst.' }, { role: 'user', content: prompt } ], temperature: 0.2 };

      var attempts = 3;
      for (var i=0; i<attempts; i++){
        var res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
          body: JSON.stringify(payload)
        });

        if (res.status === 429 || (res.status >= 500 && res.status < 600)){
          var waitMs = (500 * Math.pow(2, i)) + Math.floor(Math.random()*250);
          await new Promise(function(r){ setTimeout(r, waitMs); });
          if (i < attempts - 1) continue;
        }

        if (!res.ok){
          var text = '';
          try { text = await res.text(); } catch(e) {}
          throw new Error('HTTP ' + res.status + (text ? (' — ' + text.substring(0,180)) : ''));
        }

        var data = await res.json();
        var choice0 = data && data.choices && data.choices[0];
        return (choice0 && choice0.message && choice0.message.content) ? choice0.message.content : '(No content)';
      }

      throw new Error('Rate limited or server error after retries.');
    }

    function markedToHtml(md){
      return md
        .replace(/^### (.*$)/gim, '<h3>$1<\/h3>')
        .replace(/^## (.*$)/gim, '<h2>$1<\/h2>')
        .replace(/^# (.*$)/gim, '<h1>$1<\/h1>')
        .replace(/\*\*([^*]+)\*\*/gim, '<strong>$1<\/strong>')
        .replace(/^\* (.*)$/gim, '<li>$1<\/li>')
        .replace(/\n\n/g, '<br/><br/>')
        .replace(/\n/g, '<br/>' );
    }

    function setOutput(html){
      var out = document.getElementById('ai-output');
      if (out) out.innerHTML = markedToHtml(html);
    }

    setTimeout(function(){
      var btnLocal = document.getElementById('btn-local');
      var btnRemote = document.getElementById('btn-remote');
      var q = document.getElementById('ai-question');
      function getState(){ return window.__TENDER_STATE__ || { headers: [], filteredRows: [] }; }
      if (btnLocal) btnLocal.onclick = function(){ var s = getState(); var md = summarizeLocally(s.headers, s.filteredRows); setOutput(md); };
      if (btnRemote) btnRemote.onclick = async function(){
        var s = getState();
        var prompt = buildPrompt(s.headers, s.filteredRows, (q && q.value) ? q.value : '');
        setOutput('Running WastEye AI analysis…');
        try { var answer = await askWastEye(prompt); setOutput(answer); }
        catch(e){ setOutput('Failed: ' + e.message + '.'); }
      };
    }, 0);
  </script>
</body>
</html>
