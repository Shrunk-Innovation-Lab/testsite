<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Enhanced tender evaluation dashboard with executive insights" />
  <title>Tender Evaluation Dashboard - Enhanced</title>
  
  <!-- Tailwind CSS with inline config -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
  <script>
    window.addEventListener('load', function() {
      if (typeof tailwind !== 'undefined' && tailwind.config) {
        tailwind.config = {
          darkMode: 'class',
          theme: {
            extend: {
              fontFamily: {
                sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Inter','Helvetica Neue','Arial','Noto Sans','Apple Color Emoji','Segoe UI Emoji']
              },
              boxShadow: { 
                soft: '0 10px 30px rgba(0,0,0,0.08)',
                'soft-lg': '0 20px 40px rgba(0,0,0,0.12)'
              }
            }
          }
        };
      }
    });
  </script>
  
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Papa Parse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- ECharts -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  
  <style>
    .glass { 
      background: rgba(255,255,255,0.7); 
      backdrop-filter: blur(10px); 
      -webkit-backdrop-filter: blur(10px);
    }
    .glass-dark { 
      background: rgba(28,28,30,0.6); 
      backdrop-filter: blur(10px); 
      -webkit-backdrop-filter: blur(10px);
    }
    .spinner {
      border: 2px solid rgba(0,0,0,0.1);
      border-left-color: currentColor;
      border-radius: 50%;
      width: 1rem;
      height: 1rem;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .tooltip {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .tooltip-trigger:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    .gradient-border {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2px;
      border-radius: 1.5rem;
    }
    .gradient-border-inner {
      background: white;
      border-radius: 1.5rem;
    }
    .dark .gradient-border-inner {
      background: rgb(15, 23, 42);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100 min-h-screen font-sans antialiased">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback } = React;

    /* ===================== CONFIGURATION ===================== */
    const CONFIG = {
      FIXED_HEADERS: [
        'State', 'Site Name', 'Service Description', 'Service Type', 'Waste Stream',
        'Bin Size', 'UoM', 'QTY', 'Frequency', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 
        'Sat', 'Sun', 'Average Collected', 'Frequency', 'Collections Per Annum',
        'Average Density', 'Current EA Rate', 'Current Annual Cost', 'Notes'
      ],
      COLUMN_MAPPING: {
        filterCols: [0, 1, 2, 3, 4],
        tenderValueCol: 7,
        actualAvgCol: 16
      },
      PAGINATION: { pageSize: 15 },
      STORAGE_KEYS: {
        theme: 'tender-dashboard-theme',
        navOpen: 'tender-dashboard-nav-open'
      }
    };

    /* ===================== UTILITIES ===================== */
    const Utils = {
      isDefined(v) { return v !== undefined && v !== null; },
      coalesce(v, alt) { return this.isDefined(v) ? v : alt; },
      safeLocale(n, opts = {}) {
        if (typeof n === 'number' && !isNaN(n) && n !== null && n !== undefined) {
          try { return n.toLocaleString(undefined, opts); }
          catch (e) { return String(n); }
        }
        return String(n);
      },
      numberify(v) {
        if (v === null || v === undefined || v === '') return null;
        const s = String(v).replace(/[$¬£‚Ç¨,%\s]/g, '');
        const n = parseFloat(s);
        return isNaN(n) ? null : n;
      },
      uniqueSorted(arr) {
        return Array.from(new Set(arr.filter(v => v !== '' && v !== null && v !== undefined)))
          .sort((a, b) => String(a).localeCompare(String(b)));
      },
      sanitizeHTML(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },
      downloadCSV(rows, filename = 'export.csv') {
        try {
          if (!rows || rows.length === 0) throw new Error('No data to export');
          const csv = Papa.unparse(rows);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url; link.download = filename; link.click();
          URL.revokeObjectURL(url);
          return { success: true };
        } catch (error) {
          return { success: false, error: error.message };
        }
      },
      formatCurrency(n) {
        if (n === null || n === undefined) return '$0';
        return '$' + Math.abs(n).toLocaleString(undefined, { maximumFractionDigits: 0 });
      },
      formatPercent(n) {
        if (n === null || n === undefined || isNaN(n)) return '0%';
        return n.toFixed(1) + '%';
      }
    };

    /* ===================== CUSTOM HOOKS ===================== */
    function useTheme() {
      const getInitialTheme = () => {
        try {
          const stored = localStorage.getItem(CONFIG.STORAGE_KEYS.theme);
          return stored === 'dark';
        } catch {
          return window.matchMedia?.('(prefers-color-scheme: dark)').matches || false;
        }
      };

      const [dark, setDark] = useState(getInitialTheme);

      useEffect(() => {
        const root = document.documentElement;
        if (dark) {
          root.classList.add('dark');
          try { localStorage.setItem(CONFIG.STORAGE_KEYS.theme, 'dark'); } catch {}
        } else {
          root.classList.remove('dark');
          try { localStorage.setItem(CONFIG.STORAGE_KEYS.theme, 'light'); } catch {}
        }
      }, [dark]);

      return { dark, setDark };
    }

    function useLocalStorage(key, defaultValue) {
      const [value, setValue] = useState(() => {
        try {
          const stored = localStorage.getItem(key);
          return stored !== null ? JSON.parse(stored) : defaultValue;
        } catch {
          return defaultValue;
        }
      });

      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(value)); }
        catch (e) { console.warn('localStorage unavailable:', e); }
      }, [key, value]);

      return [value, setValue];
    }

    /* ===================== COMPONENTS ===================== */
    function LoadingSpinner({ className = "" }) {
      return <div className={`spinner ${className}`} />;
    }

    function Alert({ type = 'info', message, onClose }) {
      const colors = {
        success: 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800 text-emerald-900 dark:text-emerald-100',
        error: 'bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800 text-rose-900 dark:text-rose-100',
        warning: 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-100',
        info: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-900 dark:text-blue-100'
      };

      return (
        <div className={`rounded-2xl p-4 border ${colors[type]} flex items-start gap-3`} role="alert">
          <span className="flex-1 text-sm">{message}</span>
          {onClose && (
            <button onClick={onClose} className="opacity-60 hover:opacity-100" aria-label="Close">‚úï</button>
          )}
        </div>
      );
    }

    function Tooltip({ children, content }) {
      return (
        <div className="relative inline-block tooltip-trigger">
          {children}
          <div className="tooltip absolute z-50 px-3 py-2 text-xs bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-lg whitespace-nowrap -top-10 left-1/2 transform -translate-x-1/2">
            {content}
            <div className="absolute w-2 h-2 bg-slate-900 dark:bg-slate-100 transform rotate-45 -bottom-1 left-1/2 -translate-x-1/2"></div>
          </div>
        </div>
      );
    }

    function Chip({ children, onRemove }) {
      return (
        <span className="inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs bg-slate-900/5 dark:bg-white/10">
          {children}
          <button className="opacity-60 hover:opacity-100" onClick={onRemove} aria-label={`Remove ${children}`}>‚úï</button>
        </span>
      );
    }

    function MultiSelect({ label, options, selected, onChange }) {
      const [open, setOpen] = useState(false);
      const ref = useRef(null);

      useEffect(() => {
        function handler(e) {
          if (ref.current && !ref.current.contains(e.target)) setOpen(false);
        }
        document.addEventListener('click', handler);
        return () => document.removeEventListener('click', handler);
      }, []);

      return (
        <div className="relative" ref={ref}>
          <label className="block text-xs uppercase tracking-wide opacity-70 mb-1">{label}</label>
          <button
            onClick={() => setOpen(!open)}
            className="w-full glass dark:glass-dark border border-slate-200/60 dark:border-slate-700/50 rounded-2xl px-3 py-2 text-left shadow-soft"
          >
            <div className="flex flex-wrap gap-1 min-h-[1.5rem]">
              {selected.length === 0 && <span className="opacity-50">All</span>}
              {selected.map(v => (
                <Chip key={v} onRemove={(e) => {
                  e.stopPropagation();
                  onChange(selected.filter(s => s !== v));
                }}>
                  {v}
                </Chip>
              ))}
            </div>
          </button>
          {open && (
            <div className="absolute z-20 mt-2 max-h-64 overflow-auto w-full glass dark:glass-dark border border-slate-200/60 dark:border-slate-700/50 rounded-2xl p-2 shadow-soft-lg">
              <div className="flex items-center justify-between mb-2">
                <button className="text-xs underline" onClick={() => onChange([])}>Select none</button>
                <button className="text-xs underline" onClick={() => onChange([...options])}>Select all</button>
              </div>
              <ul className="space-y-1">
                {options.map(opt => (
                  <li key={opt}>
                    <label className="flex items-center gap-2 cursor-pointer hover:bg-slate-900/5 dark:hover:bg-white/10 rounded-xl px-2 py-1">
                      <input
                        type="checkbox"
                        className="accent-slate-900 dark:accent-slate-100"
                        checked={selected.includes(opt)}
                        onChange={(e) => {
                          if (e.target.checked) onChange([...selected, opt]);
                          else onChange(selected.filter(v => v !== opt));
                        }}
                      />
                      <span>{opt}</span>
                    </label>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      );
    }

    function EChart({ option, className = 'h-[36rem]' }) {
      const ref = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!window.echarts || !ref.current) return;

        chartRef.current = echarts.init(ref.current);
        chartRef.current.setOption(option);

        const handleResize = () => chartRef.current?.resize();
        window.addEventListener('resize', handleResize);

        return () => {
          window.removeEventListener('resize', handleResize);
          chartRef.current?.dispose();
        };
      }, [option]);

      return <div ref={ref} className={className} />;
    }

    /* ===================== EXECUTIVE SUMMARY ===================== */
    function ExecutiveSummary({ metrics, grouped, filteredRows }) {
      const [expanded, setExpanded] = useState(true);

      const insights = useMemo(() => {
        if (filteredRows.length === 0) return null;

        const deltas = filteredRows
          .map(r => ({
            delta: Utils.numberify(r[CONFIG.COLUMN_MAPPING.tenderValueCol]) - Utils.numberify(r[CONFIG.COLUMN_MAPPING.actualAvgCol]),
            site: r[1]
          }))
          .filter(d => d.delta !== null && !isNaN(d.delta));

        const sortedDeltas = [...deltas].sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));
        const positiveDeltas = deltas.filter(d => d.delta > 0);
        const negativeDeltas = deltas.filter(d => d.delta < 0);
        const totalOpportunity = positiveDeltas.reduce((sum, d) => sum + d.delta, 0);

        const highDelta = sortedDeltas.slice(0, 5);
        const bestPerformers = [...deltas].sort((a, b) => Math.abs(a.delta) - Math.abs(b.delta)).slice(0, 3);

        return {
          totalSites: new Set(filteredRows.map(r => r[1])).size,
          totalServices: filteredRows.length,
          totalOpportunity,
          opportunityPercent: metrics.tenderAvg > 0 ? (totalOpportunity / (metrics.tenderAvg * filteredRows.length)) * 100 : 0,
          highDeltaCount: positiveDeltas.filter(d => (d.delta / Math.max(1, metrics.tenderAvg)) > 0.20).length,
          topOpportunities: highDelta.filter(d => d.delta > 0).slice(0, 3),
          scopeIssues: highDelta.filter(d => d.delta < 0).slice(0, 2),
          bestPerformers
        };
      }, [filteredRows, metrics]);

      if (!insights || filteredRows.length === 0) return null;

      return (
        <section className="gradient-border">
          <div className="gradient-border-inner p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-xl font-semibold flex items-center gap-2">
                  <span>üìä</span> Executive Summary
                </h2>
                <p className="text-xs opacity-70 mt-1">AI-generated insights from your filtered data</p>
              </div>
              <button
                onClick={() => setExpanded(!expanded)}
                className="px-3 py-1 text-xs rounded-xl border border-slate-300 dark:border-slate-600 hover:bg-slate-900/5 dark:hover:bg-white/10"
              >
                {expanded ? 'Collapse' : 'Expand'}
              </button>
            </div>

            {expanded && (
              <div className="space-y-4">
                {/* Key Findings */}
                <div className="glass dark:glass-dark rounded-2xl p-4 border border-slate-200/60 dark:border-slate-700/50">
                  <h3 className="font-semibold text-sm mb-3 flex items-center gap-2">
                    <span>üéØ</span> Key Findings
                  </h3>
                  <ul className="space-y-2 text-sm">
                    <li className="flex items-start gap-2">
                      <span className="opacity-60">‚Ä¢</span>
                      <span><strong>Portfolio Size:</strong> {insights.totalServices} collection services across {insights.totalSites} sites</span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span className="opacity-60">‚Ä¢</span>
                      <span><strong>Net Opportunity:</strong> {Utils.formatCurrency(insights.totalOpportunity)} potential savings ({Utils.formatPercent(insights.opportunityPercent)})</span>
                    </li>
                    <li className="flex items-start gap-2">
                      <span className="opacity-60">‚Ä¢</span>
                      <span><strong>Priority Sites:</strong> {insights.highDeltaCount} sites show &gt;20% over-tender (review urgently)</span>
                    </li>
                  </ul>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* Top Opportunities */}
                  <div className="glass dark:glass-dark rounded-2xl p-4 border border-emerald-200/60 dark:border-emerald-700/50 bg-emerald-50/30 dark:bg-emerald-900/10">
                    <h3 className="font-semibold text-sm mb-3 flex items-center gap-2">
                      <span>üí∞</span> Top BAFO Opportunities
                    </h3>
                    {insights.topOpportunities.length > 0 ? (
                      <ol className="space-y-2 text-sm">
                        {insights.topOpportunities.map((opp, i) => (
                          <li key={i} className="flex justify-between items-center">
                            <span className="font-medium">{i + 1}. {opp.site}</span>
                            <span className="text-emerald-600 dark:text-emerald-400 font-semibold">
                              +{Utils.formatCurrency(opp.delta)}
                            </span>
                          </li>
                        ))}
                      </ol>
                    ) : (
                      <p className="text-sm opacity-70">No over-tender opportunities in current selection</p>
                    )}
                  </div>

                  {/* Best Performers */}
                  <div className="glass dark:glass-dark rounded-2xl p-4 border border-blue-200/60 dark:border-blue-700/50 bg-blue-50/30 dark:bg-blue-900/10">
                    <h3 className="font-semibold text-sm mb-3 flex items-center gap-2">
                      <span>‚≠ê</span> Best Performers
                    </h3>
                    <ol className="space-y-2 text-sm">
                      {insights.bestPerformers.map((perf, i) => (
                        <li key={i} className="flex justify-between items-center">
                          <span className="font-medium">{i + 1}. {perf.site}</span>
                          <span className="text-blue-600 dark:text-blue-400 font-semibold">
                            {Utils.formatCurrency(Math.abs(perf.delta))} variance
                          </span>
                        </li>
                      ))}
                    </ol>
                  </div>
                </div>

                {/* Recommendations */}
                <div className="glass dark:glass-dark rounded-2xl p-4 border border-slate-200/60 dark:border-slate-700/50">
                  <h3 className="font-semibold text-sm mb-3 flex items-center gap-2">
                    <span>üìã</span> Recommended Actions
                  </h3>
                  <ul className="space-y-2 text-sm">
                    <li className="flex items-start gap-2">
                      <span className="text-emerald-600 dark:text-emerald-400">‚Üí</span>
                      <span><strong>BAFO Focus:</strong> Export shortlist of {insights.topOpportunities.length} high-opportunity sites</span>
                    </li>
                    {insights.scopeIssues.length > 0 && (
                      <li className="flex items-start gap-2">
                        <span className="text-amber-600 dark:text-amber-400">‚Üí</span>
                        <span><strong>Review Scope:</strong> {insights.scopeIssues.length} sites show actual exceeding tender (investigate scope changes)</span>
                      </li>
                    )}
                    <li className="flex items-start gap-2">
                      <span className="text-blue-600 dark:text-blue-400">‚Üí</span>
                      <span><strong>Best Practice:</strong> Study {insights.bestPerformers[0]?.site} methodology for portfolio-wide improvement</span>
                    </li>
                  </ul>
                </div>
              </div>
            )}
          </div>
        </section>
      );
    }

    /* ===================== MAIN APP ===================== */
    function App() {
      const theme = useTheme();
      const [navOpen, setNavOpen] = useLocalStorage(CONFIG.STORAGE_KEYS.navOpen, true);
      const [headers, setHeaders] = useState([...CONFIG.FIXED_HEADERS]);
      const [rawRows, setRawRows] = useState([]);
      const [filters, setFilters] = useState([[], [], [], [], []]);
      const [loading, setLoading] = useState(false);
      const [alert, setAlert] = useState(null);

      useEffect(() => {
        if (alert) {
          const timer = setTimeout(() => setAlert(null), 5000);
          return () => clearTimeout(timer);
        }
      }, [alert]);

      const applyHeaderOverride = useCallback((rows) => {
        if (rows.length === 0) return { dataRows: [] };
        const first = rows[0] || [];
        let looksLikeHeader = false;
        if (first && first.length) {
          const tokens = first.slice(0, 5).map(x => String(x || '').toLowerCase());
          if (tokens.includes('state') || tokens.includes('site name')) looksLikeHeader = true;
        }
        const data = looksLikeHeader ? rows.slice(1) : rows;
        const targetLen = CONFIG.FIXED_HEADERS.length;
        const dataRows = data.map(r => {
          const copy = r.slice(0, targetLen);
          while (copy.length < targetLen) copy.push('');
          return copy;
        });
        return { dataRows };
      }, []);

      useEffect(() => {
        setLoading(true);
        fetch('data.csv', { cache: 'no-store' })
          .then(res => res.ok ? res.text() : Promise.reject('no file'))
          .then(text => Papa.parse(text, { header: false }))
          .then(result => {
            if (result?.data?.length) {
              const rows = result.data.filter(r => r && r.length);
              const { dataRows } = applyHeaderOverride(rows);
              setHeaders([...CONFIG.FIXED_HEADERS]);
              setRawRows(dataRows);
              setAlert({ type: 'success', message: `Loaded ${dataRows.length} rows` });
            }
          })
          .catch(() => {})
          .finally(() => setLoading(false));
      }, [applyHeaderOverride]);

      const onUpload = useCallback((file) => {
        if (!file || !file.name.endsWith('.csv')) {
          setAlert({ type: 'error', message: 'Please upload a CSV file' });
          return;
        }
        setLoading(true);
        Papa.parse(file, {
          header: false,
          complete: (res) => {
            try {
              const rows = res.data.filter(r => r && r.length);
              const { dataRows } = applyHeaderOverride(rows);
              setHeaders([...CONFIG.FIXED_HEADERS]);
              setRawRows(dataRows);
              setFilters([[], [], [], [], []]);
              setAlert({ type: 'success', message: `Imported ${dataRows.length} rows` });
            } catch (error) {
              setAlert({ type: 'error', message: `Import failed: ${error.message}` });
            } finally {
              setLoading(false);
            }
          }
        });
      }, [applyHeaderOverride]);

      const filterOptions = useMemo(() => {
        return CONFIG.COLUMN_MAPPING.filterCols.map(colIdx =>
          Utils.uniqueSorted(rawRows.map(r => r[colIdx]))
        );
      }, [rawRows]);

      const filteredRows = useMemo(() => {
        return rawRows.filter(r =>
          CONFIG.COLUMN_MAPPING.filterCols.every((colIdx, i) => {
            const sel = filters[i];
            return !sel || sel.length === 0 || sel.includes(r[colIdx]);
          })
        );
      }, [rawRows, filters]);

      const metrics = useMemo(() => {
        const tenderValues = filteredRows
          .map(r => Utils.numberify(r[CONFIG.COLUMN_MAPPING.tenderValueCol]))
          .filter(v => v !== null);
        const actualValues = filteredRows
          .map(r => Utils.numberify(r[CONFIG.COLUMN_MAPPING.actualAvgCol]))
          .filter(v => v !== null);

        const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const min = arr => arr.length ? Math.min(...arr) : 0;
        const max = arr => arr.length ? Math.max(...arr) : 0;

        return {
          count: filteredRows.length,
          tenderAvg: avg(tenderValues),
          tenderMin: min(tenderValues),
          tenderMax: max(tenderValues),
          actualAvg: avg(actualValues),
          actualMin: min(actualValues),
          actualMax: max(actualValues),
          deltaAvg: avg(tenderValues) - avg(actualValues)
        };
      }, [filteredRows]);

      const groupLabelIdx = useMemo(() => {
        const idx = headers.findIndex(h => String(h || '').toLowerCase() === 'site name');
        return idx !== -1 ? idx : 1;
      }, [headers]);

      const grouped = useMemo(() => {
        const groups = new Map();
        filteredRows.forEach(r => {
          const label = Utils.isDefined(r[groupLabelIdx]) ? r[groupLabelIdx] : '‚Äî';
          const tender = Utils.numberify(r[CONFIG.COLUMN_MAPPING.tenderValueCol]);
          const actual = Utils.numberify(r[CONFIG.COLUMN_MAPPING.actualAvgCol]);
          if (!groups.has(label)) groups.set(label, { label, tenders: [], actuals: [] });
          if (tender !== null) groups.get(label).tenders.push(tender);
          if (actual !== null) groups.get(label).actuals.push(actual);
        });
        return Array.from(groups.values())
          .map(g => ({
            label: g.label,
            tender: g.tenders.length ? g.tenders.reduce((a, b) => a + b, 0) / g.tenders.length : 0,
            actual: g.actuals.length ? g.actuals.reduce((a, b) => a + b, 0) / g.actuals.length : 0
          }))
          .sort((a, b) => String(a.label).localeCompare(String(b.label)));
      }, [filteredRows, groupLabelIdx]);

      // Delta histogram data
      const histogramData = useMemo(() => {
        const deltas = filteredRows
          .map(r => Utils.numberify(r[CONFIG.COLUMN_MAPPING.tenderValueCol]) - Utils.numberify(r[CONFIG.COLUMN_MAPPING.actualAvgCol]))
          .filter(v => v !== null && !isNaN(v));
        
        if (deltas.length === 0) return [];
        
        const min = Math.min(...deltas);
        const max = Math.max(...deltas);
        const binCount = 20;
        const binSize = (max - min) / binCount;
        
        const bins = Array(binCount).fill(0);
        deltas.forEach(d => {
          const binIdx = Math.min(Math.floor((d - min) / binSize), binCount - 1);
          bins[binIdx]++;
        });
        
        return bins.map((count, i) => ({
          value: min + (i * binSize) + (binSize / 2),
          count
        }));
      }, [filteredRows]);

      const exportFiltered = useCallback(() => {
        const result = Utils.downloadCSV(
          [headers, ...filteredRows],
          `tenders_filtered_${new Date().toISOString().split('T')[0]}.csv`
        );
        if (result.success) setAlert({ type: 'success', message: 'Export successful!' });
        else setAlert({ type: 'error', message: `Export failed: ${result.error}` });
      }, [headers, filteredRows]);

      useEffect(() => {
        setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
      }, [navOpen]);

      // Enhanced bar chart
      const barOption = useMemo(() => ({
        tooltip: { 
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          formatter: (params) => {
            let result = `<strong>${params[0].name}</strong><br/>`;
            params.forEach(p => {
              result += `${p.marker} ${p.seriesName}: ${Utils.formatCurrency(p.value)}<br/>`;
            });
            if (params.length >= 2) {
              const delta = params[0].value - params[1].value;
              const color = delta >= 0 ? '#10b981' : '#ef4444';
              result += `<span style="color:${color}">Œî: ${Utils.formatCurrency(delta)}</span>`;
            }
            return result;
          }
        },
        legend: { data: ['Tender (H)', 'Actual (Q)'], bottom: 0 },
        grid: { left: 160, right: 30, top: 30, bottom: 60 },
        xAxis: { type: 'value', name: 'Average Value' },
        yAxis: {
          type: 'category',
          data: grouped.map(d => d.label),
          axisLabel: { interval: 0, fontSize: 11, width: 140, overflow: 'truncate' }
        },
        dataZoom: [
          { type: 'slider', yAxisIndex: 0, start: 0, end: 100, width: 14, right: 6 },
          { type: 'inside', yAxisIndex: 0 }
        ],
        series: [
          { 
            type: 'bar', name: 'Tender (H)', 
            data: grouped.map(d => d.tender),
            itemStyle: { color: '#3b82f6', borderRadius: [0, 4, 4, 0] },
            barMaxWidth: 18
          },
          { 
            type: 'bar', name: 'Actual (Q)', 
            data: grouped.map(d => d.actual),
            itemStyle: { color: '#10b981', borderRadius: [0, 4, 4, 0] },
            barMaxWidth: 18
          }
        ]
      }), [grouped]);

      // Delta histogram chart
      const histogramOption = useMemo(() => ({
        title: { text: 'Delta Distribution', left: 'center', textStyle: { fontSize: 14 } },
        tooltip: {
          trigger: 'axis',
          formatter: (params) => {
            const p = params[0];
            return `Delta: ${Utils.formatCurrency(p.value[0])}<br/>Count: ${p.value[1]} sites`;
          }
        },
        grid: { left: 50, right: 20, top: 50, bottom: 50 },
        xAxis: { type: 'value', name: 'Delta (H - Q)', nameLocation: 'center', nameGap: 30 },
        yAxis: { type: 'value', name: 'Frequency' },
        series: [{
          type: 'bar',
          data: histogramData.map(d => [d.value, d.count]),
          itemStyle: {
            color: (params) => params.value[0] >= 0 ? '#10b981' : '#ef4444'
          },
          barWidth: '80%'
        }],
        markLine: {
          silent: true,
          symbol: 'none',
          lineStyle: { type: 'dashed', color: '#94a3b8', width: 2 },
          data: [{ xAxis: 0, label: { formatter: 'Perfect Match', position: 'end' } }]
        }
      }), [histogramData]);

      /* ===================== RENDER ===================== */
      return (
        <>
          {loading && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
              <div className="glass dark:glass-dark rounded-3xl p-8 flex items-center gap-4">
                <LoadingSpinner className="w-6 h-6" />
                <span>Processing...</span>
              </div>
            </div>
          )}

          <div className="max-w-7xl mx-auto p-4 md:p-8">
            {alert && (
              <div className="mb-4">
                <Alert {...alert} onClose={() => setAlert(null)} />
              </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
              {navOpen && (
                <aside className="lg:col-span-3 space-y-4">
                  <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft sticky top-4">
                    <div className="flex items-center justify-between mb-3">
                      <h2 className="text-lg font-semibold">Filters & Controls</h2>
                      <button
                        onClick={() => setNavOpen(false)}
                        className="text-xs px-2 py-1 rounded-xl border border-slate-200/60 dark:border-slate-700/50"
                      >
                        Hide
                      </button>
                    </div>

                    <div className="space-y-2 mb-4">
                      <label className="flex items-center gap-2 text-sm glass dark:glass-dark px-3 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={theme.dark}
                          onChange={e => theme.setDark(e.target.checked)}
                          className="accent-slate-900 dark:accent-slate-100"
                        />
                        <span>Dark Mode</span>
                      </label>

                      <label className="flex items-center justify-center gap-2 text-sm glass dark:glass-dark px-3 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 cursor-pointer">
                        <input
                          type="file"
                          accept=".csv"
                          className="hidden"
                          onChange={e => e.target.files?.[0] && onUpload(e.target.files[0])}
                        />
                        <span>üìÅ Upload CSV</span>
                      </label>

                      <button
                        className="w-full px-3 py-2 rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-soft disabled:opacity-50"
                        onClick={exportFiltered}
                        disabled={filteredRows.length === 0}
                      >
                        üíæ Export CSV
                      </button>
                    </div>

                    <div className="space-y-3">
                      <h3 className="font-medium text-sm">Data Filters</h3>
                      {CONFIG.COLUMN_MAPPING.filterCols.slice(0, 5).map((colIdx, i) => (
                        <MultiSelect
                          key={i}
                          label={`${String.fromCharCode(65 + i)} ‚Äî ${headers[colIdx] || 'Column'}`}
                          options={filterOptions[i] || []}
                          selected={filters[i]}
                          onChange={vals => {
                            const next = [...filters];
                            next[i] = vals;
                            setFilters(next);
                          }}
                        />
                      ))}
                    </div>
                  </div>
                </aside>
              )}

              <main className={`${navOpen ? 'lg:col-span-9' : 'lg:col-span-12'} space-y-6`}>
                <section className="flex items-center justify-between">
                  <div>
                    <h1 className="text-2xl md:text-3xl font-semibold">Tender Evaluation Dashboard</h1>
                    <p className="text-sm opacity-70 mt-1">Enhanced with executive insights & advanced analytics</p>
                  </div>
                  {!navOpen && (
                    <button
                      onClick={() => setNavOpen(true)}
                      className="px-3 py-2 rounded-2xl glass dark:glass-dark border border-slate-200/60 dark:border-slate-700/50"
                    >
                      Show Filters
                    </button>
                  )}
                </section>

                {/* Executive Summary */}
                <ExecutiveSummary metrics={metrics} grouped={grouped} filteredRows={filteredRows} />

                {/* Metrics */}
                <section className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <Tooltip content="Total filtered records">
                    <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                      <div className="text-xs uppercase tracking-wide opacity-70">Records</div>
                      <div className="text-3xl font-semibold mt-1">{metrics.count.toLocaleString()}</div>
                    </div>
                  </Tooltip>

                  <Tooltip content="Average tender value (Column H)">
                    <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                      <div className="text-xs uppercase tracking-wide opacity-70">Tender Avg (H)</div>
                      <div className="text-3xl font-semibold mt-1">{Utils.safeLocale(metrics.tenderAvg, { maximumFractionDigits: 2 })}</div>
                      <div className="text-xs opacity-70 mt-1">Range: {Utils.safeLocale(metrics.tenderMin)} ‚Äì {Utils.safeLocale(metrics.tenderMax)}</div>
                    </div>
                  </Tooltip>

                  <Tooltip content="Average actual collected (Column Q)">
                    <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                      <div className="text-xs uppercase tracking-wide opacity-70">Actual Avg (Q)</div>
                      <div className="text-3xl font-semibold mt-1">{Utils.safeLocale(metrics.actualAvg, { maximumFractionDigits: 2 })}</div>
                      <div className="text-xs opacity-70 mt-1">Range: {Utils.safeLocale(metrics.actualMin)} ‚Äì {Utils.safeLocale(metrics.actualMax)}</div>
                    </div>
                  </Tooltip>

                  <Tooltip content="Positive = BAFO opportunity">
                    <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                      <div className="text-xs uppercase tracking-wide opacity-70">Delta (H ‚àí Q)</div>
                      <div className={`text-3xl font-semibold mt-1 ${metrics.deltaAvg >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>
                        {metrics.deltaAvg >= 0 ? '+' : ''}{Utils.safeLocale(metrics.deltaAvg, { maximumFractionDigits: 2 })}
                      </div>
                      <div className="text-xs opacity-70 mt-1">{metrics.deltaAvg >= 0 ? 'BAFO opportunity' : 'Review scope'}</div>
                    </div>
                  </Tooltip>
                </section>

                {/* Charts */}
                <section className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                    <h3 className="font-semibold mb-2">Tender vs Actual by Site</h3>
                    {grouped.length > 0 ? (
                      <EChart option={barOption} className="h-[40rem]" />
                    ) : (
                      <div className="h-[40rem] flex items-center justify-center opacity-50">No data</div>
                    )}
                  </div>

                  <div className="glass dark:glass-dark rounded-3xl p-4 border border-slate-200/60 dark:border-slate-700/50 shadow-soft">
                    <h3 className="font-semibold mb-2">Delta Distribution</h3>
                    {histogramData.length > 0 ? (
                      <EChart option={histogramOption} className="h-[40rem]" />
                    ) : (
                      <div className="h-[40rem] flex items-center justify-center opacity-50">No data</div>
                    )}
                  </div>
                </section>

                <footer className="text-xs opacity-70 text-center py-6 border-t border-slate-200/60 dark:border-slate-700/50">
                  Enhanced Tender Evaluation Dashboard ‚Ä¢ Built with React, Tailwind & ECharts
                </footer>
              </main>
            </div>
          </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
