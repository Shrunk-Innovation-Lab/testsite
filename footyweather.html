<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Weather Lookup (Tesla UI Style)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Ionicons for icons -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <style>
    /* Base theme variables */
    :root {
      --bg-page-dark: #121212;
      --bg-page-light: #f0f0f0;
      --text-dark: #ffffff;
      --text-light: #000000;
      --bg-control-dark: rgba(18,18,18,0.95);
      --bg-control-light: rgba(255,255,255,0.8);
      --bg-sheet-dark: #1b1b1b;
      --bg-sheet-light: #ffffff;
    }
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: var(--bg-page-dark);
      color: var(--text-dark);
      font-family: Helvetica Neue, sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: var(--bg-page-light);
      color: var(--text-light);
    }
    /* Top control bar */
    #controls {
      position: fixed; top: 0; left: 0; right: 0;
      display: flex; align-items: center; gap: 12px;
      padding: env(safe-area-inset-top) 16px 12px;
      background: var(--bg-control-dark);
      backdrop-filter: blur(12px);
      z-index: 1001;
      transition: background 0.3s;
    }
    body.light-mode #controls {
      background: var(--bg-control-light);
    }
    /* Logo */
    #logo { height: 32px; width: auto; margin-right: 8px; }
    /* Switch */
    .switch {
      position: relative; display: inline-block; width: 40px; height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ccc; transition: 0.4s; border-radius: 20px;
    }
    .slider:before {
      position: absolute; content: "";
      height: 16px; width: 16px;
      left: 2px; bottom: 2px;
      background: white; transition: 0.4s; border-radius: 50%;
    }
    input:checked + .slider {
      background: #007aff;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    /* Address input */
    #addressInput {
      flex: 1; height: 40px; padding: 8px 12px;
      font-size: 16px; color: inherit;
      background: var(--bg-control-dark);
      border: none; border-radius: 8px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.7);
      -webkit-appearance: none;
      transition: background 0.3s;
    }
    body.light-mode #addressInput {
      background: var(--bg-sheet-light);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    #addressInput:focus { outline: none; }
    /* Icon button */
    .btn {
      background: none; border: none;
      color: inherit; font-size: 20px;
      padding: 8px; border-radius: 50%;
      cursor: pointer; transition: background 0.2s;
    }
    .btn:hover { background: rgba(232,33,39,0.2); }
    .btn.clear:hover { background: rgba(232,33,39,0.3); }
    /* Fullscreen map */
    #map {
      position: absolute;
      top: calc(60px + env(safe-area-inset-top)); bottom: 0;
      left: 0; right: 0;
      filter: brightness(1.3);
      transition: filter 0.3s;
    }
    /* Bottom sheet */
    #weather {
      position: fixed; bottom: 0; left: 50%;
      transform: translate(-50%, 100%);
      width: 90%; max-width: 400px;
      background: var(--bg-sheet-dark);
      border-radius: 16px 16px 0 0;
      padding: 16px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease, background 0.3s;
      z-index: 1002;
    }
    body.light-mode #weather {
      background: var(--bg-sheet-light);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }
    #weather.show { transform: translate(-50%, 0); opacity: 1; }
    $1
    #weather .row:first-child {
      justify-content: center;
    }
    #weather .row ion-icon { font-size: 24px !important; width: 24px; height: 24px; }
  </style>
</head>
<body>
  <div id="controls">
    <img id="logo" src="https://i.imgur.com/lIOr2wQ.png" alt="Logo">
    <label class="switch">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>
    <input id="addressInput" placeholder="Search address...">
    <button id="searchBtn" class="btn"><ion-icon name="search-outline"></ion-icon></button>
    <button id="locateBtn" class="btn"><ion-icon name="locate-outline"></ion-icon></button>
    <button id="clearBtn" class="btn clear"><ion-icon name="trash-outline"></ion-icon></button>
  </div>
  <div id="map"></div>
  <div id="weather"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const defaultCoords = [-37.8136,144.9631];
      const defaultZoom = 13;
      const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap contributors' });
      const lightLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' });
      const map = L.map('map', { layers: [darkLayer] }).setView(defaultCoords, defaultZoom);
      let currentLayer = darkLayer;

      // Mode toggle
      const toggle = document.getElementById('modeToggle');
      toggle.addEventListener('change', () => {
        document.body.classList.toggle('light-mode', toggle.checked);
        map.removeLayer(currentLayer);
        currentLayer = toggle.checked ? lightLayer : darkLayer;
        currentLayer.addTo(map);
      });

      // Tesla-style red marker icon
      // AFL football icon marker
      // AFL football SVG icon marker
      const footballIcon = L.divIcon({
        html: `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 200" width="32" height="32">
            <!-- Outer oval -->
            <ellipse cx="60" cy="100" rx="50" ry="90" stroke="#000" stroke-width="10" fill="red" />
            <!-- Central seam -->
            <line x1="60" y1="20" x2="60" y2="180" stroke="#000" stroke-width="10" stroke-linecap="round" />
            <!-- 3 lace bars -->
            <g stroke="#000" stroke-width="6" stroke-linecap="round">
              <line x1="40" y1="80" x2="80" y2="80" />
              <line x1="40" y1="100" x2="80" y2="100" />
              <line x1="40" y1="120" x2="80" y2="120" />
            </g>
          </svg>
        `,
        className: '',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      });

      let marker = null;
      const weatherDiv = document.getElementById('weather');

      // Set marker and pan
      const setMarker = (lat, lon) => {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon], { icon: footballIcon }).addTo(map);
        map.panTo([lat, lon]);
      };

      const showWeather = () => weatherDiv.classList.add('show');
      const hideWeather = () => weatherDiv.classList.remove('show');
      const clearAll = () => {
        if (marker) { map.removeLayer(marker); marker = null; }
        hideWeather(); document.getElementById('addressInput').value = '';
        map.setView(defaultCoords, defaultZoom);
      };

      const fetchWeather = (lat, lon) => {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=${encodeURIComponent(tz)}`;
        const geocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
        Promise.all([
          fetch(weatherUrl, { cache: 'no-store' }).then(res => res.json()),
          fetch(geocodeUrl).then(res => res.json())
        ])
        .then(([wData, gData]) => {
          const w = wData.current_weather;
          const address = gData.display_name;
          weatherDiv.innerHTML = `
            <div class="row">${address}</div>
            <div class="row"><ion-icon name="thermometer-outline"></ion-icon><strong>${w.temperature}°C</strong></div>
            <div class="row"><ion-icon name="speedometer-outline"></ion-icon>${w.windspeed} km/h @ ${w.winddirection}°</div>
            <div class="row"><ion-icon name="time-outline"></ion-icon>${new Date(w.time).toLocaleString()}</div>
          `;
          showWeather();
        })
        .catch(() => {
          weatherDiv.innerHTML = '<div class="row">Error fetching weather.</div>';
          showWeather();
        });
      };

      map.on('click', e => { setMarker(e.latlng.lat, e.latlng.lng); fetchWeather(e.latlng.lat, e.latlng.lng); });
      document.getElementById('searchBtn').addEventListener('click', () => {
        const address = document.getElementById('addressInput').value.trim(); if (!address) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
          .then(res => res.json()).then(results => { if (!results.length) return; const { lat, lon } = results[0]; setMarker(lat, lon); fetchWeather(lat, lon); });
      });
      document.getElementById('locateBtn').addEventListener('click', () => {
        if (!navigator.geolocation) return; navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; setMarker(latitude, longitude); fetchWeather(latitude, longitude); }, () => {});
      });
      document.getElementById('clearBtn').addEventListener('click', clearAll);
    });
  </script>
</body>
</html>
