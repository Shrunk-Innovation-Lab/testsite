<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BinSpy RFID - Checkpoint Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="https://i.imgur.com/dZR7M8C.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/dZR7M8C.png">
    <style>
        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 12px 15px;
            -webkit-font-smoothing: antialiased;
        }

        .page {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px 0 4px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .logo {
            height: 38px;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.25em;
            font-weight: 600;
            color: #1d1d1f;
            text-align: left;
            flex: 1;
            min-width: 0;
        }

        .header-title span {
            display: block;
            font-size: 0.78em;
            font-weight: 500;
            color: #5f5f62;
            margin-top: 2px;
        }

        .home-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: 1px solid #d2d2d7;
            background-color: #ffffff;
            text-decoration: none;
            color: #007aff;
            flex-shrink: 0;
            transition: background-color 0.18s, box-shadow 0.18s, transform 0.08s;
        }

        .home-link svg {
            width: 18px;
            height: 18px;
        }

        .home-link:active {
            transform: scale(0.96);
            box-shadow: 0 1px 4px rgba(0,0,0,0.18);
        }

        .container {
            width: 100%;
        }

        .controls-row {
            background-color: #ffffff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .view-btn, .export-btn, .nav-btn, .filter-btn, .refresh-btn {
            padding: 10px 18px;
            border: 1px solid #d2d2d7;
            background-color: #ffffff;
            color: #1d1d1f;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            white-space: nowrap;
        }

        .view-btn:active, .filter-btn:active {
            transform: scale(0.97);
        }

        .view-btn.active {
            background-color: #007aff;
            color: white;
            border-color: #007aff;
        }

        .export-btn {
            background-color: #34c759;
            color: white;
            border-color: #34c759;
        }

        .export-btn:active {
            background-color: #2fb350;
            transform: scale(0.97);
        }

        .refresh-btn {
            background-color: #007aff;
            color: white;
            border-color: #007aff;
        }

        .refresh-btn:active {
            background-color: #0056b3;
            transform: scale(0.97);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #ffffff;
            padding: 18px 16px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            text-align: center;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.detections .stat-number {
            color: #007aff;
        }

        .stat-card.bins .stat-number {
            color: #34c759;
        }

        .stat-card.today .stat-number {
            color: #ff9500;
        }

        .stat-card.recent .stat-number {
            color: #af52de;
        }

        .bins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .bin-card {
            background-color: #ffffff;
            padding: 14px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #007aff;
        }

        .bin-card:active {
            transform: scale(0.98);
        }

        .bin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .bin-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
            flex: 1;
        }

        .detection-count {
            background-color: #007aff;
            color: white;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.85em;
        }

        .bin-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 6px 10px;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .bin-info-label {
            font-weight: 600;
            color: #666;
        }

        .bin-info-value {
            color: #1d1d1f;
        }

        .bin-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 6px;
            margin-top: 4px;
        }

        .badge-size {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .badge-waste {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-signal {
            background-color: #e8f5e9;
            color: #388e3c;
        }

        .badge-signal.poor {
            background-color: #ffebee;
            color: #c62828;
        }

        .last-seen {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8em;
            color: #666;
        }

        .loading {
            text-align: center;
            color: #1d1d1f;
            font-size: 1.25em;
            padding: 40px 20px;
        }

        .error {
            background-color: #ffe5e5;
            color: #c41e3a;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            border: 1px solid #ffcccc;
        }

        .filters {
            background-color: #ffffff;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            white-space: nowrap;
        }

        .filter-btn {
            padding: 8px 14px;
            min-height: 36px;
            font-size: 0.9em;
        }

        .filter-btn.active {
            background-color: #007aff;
            color: white;
            border-color: #007aff;
        }

        .search-box {
            flex: 1;
            min-width: 180px;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background-color: #ffffff;
            min-height: 40px;
        }

        .search-box:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        .timeline-container {
            background-color: #ffffff;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            margin-bottom: 20px;
        }

        .timeline-header {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .timeline-event {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid #007aff;
            transition: transform 0.2s;
        }

        .timeline-event:hover {
            transform: translateX(4px);
        }

        .timeline-time-col {
            flex-shrink: 0;
            width: 100px;
            text-align: right;
        }

        .timeline-time {
            font-weight: 700;
            color: #007aff;
            font-size: 0.95em;
        }

        .timeline-date {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-bin-name {
            font-weight: 600;
            font-size: 1em;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .timeline-details {
            font-size: 0.85em;
            color: #666;
        }

        .calendar-container {
            background-color: #ffffff;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #d2d2d7;
            margin-bottom: 10px;
            width: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 12px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            min-height: 36px;
            font-size: 0.9rem;
        }

        .nav-btn:active {
            background-color: #0056b3;
            transform: scale(0.97);
        }

        .calendar-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #1d1d1f;
            text-align: center;
            flex: 1 1 140px;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 8px 4px;
            color: #007aff;
            font-size: 0.82em;
        }

        .day-cell {
            min-height: 70px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            padding: 6px 4px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #ffffff;
        }

        .day-cell:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        }

        .day-cell.other-month {
            opacity: 0.3;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1d1d1f;
            font-size: 0.9em;
        }

        .day-count {
            background-color: #007aff;
            color: white;
            padding: 3px 6px;
            border-radius: 999px;
            font-size: 0.75em;
            font-weight: 700;
            display: inline-block;
        }

        footer {
            margin-top: auto;
            text-align: center;
            padding: 15px 20px 10px;
            font-size: 12px;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .last-updated {
            text-align: center;
            color: #666;
            margin: 8px 0 12px 0;
            font-size: 0.82em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .refresh-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #34c759;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-indicator.active {
            opacity: 1;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media screen and (max-width: 768px) {
            body {
                padding: 10px 10px 14px;
            }

            .header-title {
                font-size: 1.1em;
            }

            .bins-grid {
                grid-template-columns: 1fr;
            }

            .timeline-time-col {
                width: 70px;
                font-size: 0.9em;
            }

            .filter-group {
                width: 100%;
            }

            .filter-label {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <div class="header-left">
            <img src="https://i.imgur.com/iB983sa.png" alt="BinSpy Logo" class="logo">
            <h1 class="header-title">
                BinSpy RFID Checkpoint Tracker
                <span id="heartbeatStatus">Loading heartbeat...</span>
            </h1>
        </div>
        <a href="menu.html" class="home-link" aria-label="Back to BinSpy menu">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 11L12 4L20 11V20H14V14H10V20H4V11Z"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"/>
            </svg>
        </a>
    </header>

    <div class="container">
        <div class="loading" id="loading">Loading RFID data...</div>
        <div class="error" id="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="controls-row">
                <div class="view-toggle">
                    <button class="view-btn active" data-view="dashboard">Dashboard</button>
                    <button class="view-btn" data-view="timeline">Timeline</button>
                    <button class="view-btn" data-view="calendar">Calendar</button>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; flex: 0 1 auto;">
                    <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">
                        Refresh
                    </button>
                    <button class="export-btn" id="exportBtn" onclick="exportToCSV()">
                        Export CSV
                    </button>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated">
                <span class="refresh-indicator" id="refreshIndicator"></span>
                <span id="lastUpdatedText"></span>
            </div>

            <div id="dashboardView">
                <div class="stats" id="stats"></div>

                <div class="filters">
                    <input type="text" class="search-box" id="searchBox" placeholder="Search bins...">
                    <div class="filter-group">
                        <span class="filter-label">Waste Type:</span>
                        <button class="filter-btn active" data-filter-type="waste" data-filter="all">All</button>
                        <div id="wasteTypeFilters"></div>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Bin Size:</span>
                        <button class="filter-btn active" data-filter-type="size" data-filter="all">All</button>
                        <div id="binSizeFilters"></div>
                    </div>
                </div>

                <div class="bins-grid" id="binsGrid"></div>
            </div>

            <div id="timelineView" class="hidden">
                <div class="timeline-container">
                    <div class="timeline-header">
                        <span>Recent Detections</span>
                        <select id="timelineFilter" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #d2d2d7;">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="timeline" id="timeline"></div>
                </div>
            </div>

            <div id="calendarView" class="hidden">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="nav-btn" id="prevBtn">← Prev</button>
                            <button class="nav-btn" id="todayBtn">Today</button>
                            <button class="nav-btn" id="nextBtn">Next →</button>
                        </div>
                        <div class="calendar-title" id="calendarTitle"></div>
                    </div>
                    <div id="calendarContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    2025 | Wasted by Shrunk | All Rights Reserved
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPVoP6ihWhIntuCPMue-FMy8bWqa8YjsDeuaBiLPbm3tdWezDP08uxy2WybrTmLEiFr9UMLVzr_TJF/pub?gid=0&single=true&output=csv';
    const HEARTBEAT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTPVoP6ihWhIntuCPMue-FMy8bWqa8YjsDeuaBiLPbm3tdWezDP08uxy2WybrTmLEiFr9UMLVzr_TJF/pub?gid=1744529929&single=true&output=csv';

    let allDetections = [];
    let lastHeartbeat = null;
    let currentView = 'dashboard';
    let searchTerm = '';
    let wasteTypeFilter = 'all';
    let binSizeFilter = 'all';
    let timelineFilter = 'all';
    let currentDate = new Date();

    function parseTimestamp(timestamp) {
        if (timestamp instanceof Date) {
            return timestamp;
        }
        
        if (typeof timestamp === 'string') {
            // Try parsing DD/MM/YYYY HH:MM:SS format
            const parts = timestamp.trim().split(' ');
            if (parts.length >= 2) {
                const dateParts = parts[0].split('/');
                const timeParts = parts[1].split(':');
                
                if (dateParts.length === 3 && timeParts.length >= 2) {
                    // DD/MM/YYYY format
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // Months are 0-indexed
                    const year = parseInt(dateParts[2]);
                    const hour = parseInt(timeParts[0]);
                    const minute = parseInt(timeParts[1]);
                    const second = parseInt(timeParts[2] || 0);
                    
                    return new Date(year, month, day, hour, minute, second);
                }
            }
            
            // Fallback to standard parsing
            return new Date(timestamp);
        }
        
        return new Date();
    }

    function getBinStats() {
        const uniqueBins = new Map();
        
        allDetections.forEach(detection => {
            const mac = detection.MAC || detection.mac;
            if (!mac) return;
            
            if (!uniqueBins.has(mac)) {
                uniqueBins.set(mac, {
                    name: detection.Name || detection.name || 'Unknown',
                    binSize: detection['Bin Size'] || detection.binSize || 'Unknown',
                    wasteType: detection['Waste Type'] || detection.wasteType || 'Unknown',
                    detections: [],
                    lastSeen: detection.timestamp,
                    avgRSSI: 0,
                    avgQuality: ''
                });
            }
            
            const bin = uniqueBins.get(mac);
            bin.detections.push(detection);
            if (detection.timestamp > bin.lastSeen) {
                bin.lastSeen = detection.timestamp;
            }
        });
        
        uniqueBins.forEach((bin, mac) => {
            const rssiValues = bin.detections
                .map(d => parseFloat(d.RSSI || d.rssi))
                .filter(v => !isNaN(v));
            
            if (rssiValues.length > 0) {
                bin.avgRSSI = (rssiValues.reduce((a, b) => a + b, 0) / rssiValues.length).toFixed(1);
            }
            
            const qualities = bin.detections.map(d => d.Quality || d.quality).filter(q => q);
            if (qualities.length > 0) {
                bin.avgQuality = qualities[qualities.length - 1];
            }
        });
        
        return uniqueBins;
    }

    function getUniqueWasteTypes() {
        const types = new Set();
        allDetections.forEach(d => {
            const wasteType = d['Waste Type'] || d.wasteType;
            if (wasteType) types.add(wasteType);
        });
        return Array.from(types).sort();
    }

    function getUniqueBinSizes() {
        const sizes = new Set();
        allDetections.forEach(d => {
            const binSize = d['Bin Size'] || d.binSize;
            if (binSize) sizes.add(binSize);
        });
        return Array.from(sizes).sort();
    }

    async function loadHeartbeat() {
        try {
            const response = await fetch(HEARTBEAT_URL + '&t=' + new Date().getTime());
            const csvText = await response.text();

            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('Heartbeat data received:', results.data);
                    if (results.data && results.data.length > 0) {
                        // Get the last row (most recent heartbeat)
                        const latest = results.data[results.data.length - 1];
                        console.log('Latest heartbeat row:', latest);
                        
                        const timestampStr = latest.Timestamp || latest.timestamp;
                        console.log('Timestamp string:', timestampStr);
                        
                        const parsedTimestamp = parseTimestamp(timestampStr);
                        console.log('Parsed timestamp:', parsedTimestamp);
                        
                        lastHeartbeat = {
                            timestamp: parsedTimestamp,
                            deviceTime: latest['Device Time'] || latest.deviceTime || 'Unknown'
                        };
                        console.log('Last heartbeat set to:', lastHeartbeat);
                        updateHeartbeatDisplay();
                    } else {
                        console.log('No heartbeat data found');
                    }
                },
                error: function(error) {
                    console.error('Error parsing heartbeat:', error);
                }
            });
        } catch (error) {
            console.error('Error fetching heartbeat:', error);
        }
    }

    function updateHeartbeatDisplay() {
        const statusElement = document.getElementById('heartbeatStatus');
        if (!statusElement) return;

        if (lastHeartbeat) {
            const now = new Date();
            console.log('Current time:', now);
            console.log('Heartbeat time:', lastHeartbeat.timestamp);
            
            const diffMs = now - lastHeartbeat.timestamp;
            console.log('Difference in ms:', diffMs);
            
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);

            let statusText = '';
            let statusColor = '';

            if (diffMins < 60) {
                statusText = `Last heartbeat: ${diffMins}m ago`;
                statusColor = '#34c759'; // Green - within the hour
            } else if (diffHours < 2) {
                statusText = `Last heartbeat: ${diffHours}h ${diffMins % 60}m ago`;
                statusColor = '#34c759'; // Green - slightly over 1 hour is ok
            } else if (diffHours < 3) {
                statusText = `Last heartbeat: ${diffHours}h ${diffMins % 60}m ago`;
                statusColor = '#ff9500'; // Orange - 2-3 hours, warning
            } else {
                statusText = `Last heartbeat: ${diffHours}h ${diffMins % 60}m ago`;
                statusColor = '#ff3b30'; // Red - more than 3 hours, alert
            }

            console.log('Display text:', statusText);
            statusElement.textContent = statusText;
            statusElement.style.color = statusColor;
        } else {
            statusElement.textContent = 'Waiting for heartbeat...';
            statusElement.style.color = '#666';
        }
    }

    async function loadData(isAutoRefresh = false) {
        const indicator = document.getElementById('refreshIndicator');
        if (indicator && isAutoRefresh) {
            indicator.classList.add('active');
        }

        try {
            const response = await fetch(CSV_URL + '&t=' + new Date().getTime());
            const csvText = await response.text();

            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allDetections = results.data.map(row => ({
                        ...row,
                        timestamp: parseTimestamp(row.Timestamp || row.timestamp)
                    })).sort((a, b) => b.timestamp - a.timestamp);

                    loadHeartbeat();
                    populateFilters();
                    displayCurrentView();

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';

                    if (indicator && isAutoRefresh) {
                        setTimeout(() => indicator.classList.remove('active'), 500);
                    }
                },
                error: function(error) {
                    showError('Error parsing CSV: ' + error.message);
                    if (indicator) {
                        indicator.classList.remove('active');
                    }
                }
            });
        } catch (error) {
            showError('Error loading data: ' + error.message);
            if (indicator) {
                indicator.classList.remove('active');
            }
        }
    }

    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = message;
    }

    function populateFilters() {
        const wasteTypes = getUniqueWasteTypes();
        const wasteTypeFilters = document.getElementById('wasteTypeFilters');
        wasteTypeFilters.innerHTML = wasteTypes.map(type => 
            `<button class="filter-btn" data-filter-type="waste" data-filter="${type}">${type}</button>`
        ).join('');

        const binSizes = getUniqueBinSizes();
        const binSizeFilters = document.getElementById('binSizeFilters');
        binSizeFilters.innerHTML = binSizes.map(size => 
            `<button class="filter-btn" data-filter-type="size" data-filter="${size}">${size}</button>`
        ).join('');
    }

    function displayCurrentView() {
        document.getElementById('dashboardView').classList.toggle('hidden', currentView !== 'dashboard');
        document.getElementById('timelineView').classList.toggle('hidden', currentView !== 'timeline');
        document.getElementById('calendarView').classList.toggle('hidden', currentView !== 'calendar');

        if (currentView === 'dashboard') {
            displayDashboard();
        } else if (currentView === 'timeline') {
            displayTimeline();
        } else if (currentView === 'calendar') {
            displayCalendar();
        }
        
        updateLastUpdated();
    }

    function displayDashboard() {
        displayStats();
        displayBins();
    }

    function displayStats() {
        const totalDetections = allDetections.length;
        const uniqueBins = getBinStats().size;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayDetections = allDetections.filter(d => d.timestamp >= today).length;
        
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
        const recentDetections = allDetections.filter(d => d.timestamp >= oneHourAgo).length;

        document.getElementById('stats').innerHTML = `
            <div class="stat-card detections">
                <div class="stat-number">${totalDetections.toLocaleString()}</div>
                <div class="stat-label">Total Detections</div>
            </div>
            <div class="stat-card bins">
                <div class="stat-number">${uniqueBins}</div>
                <div class="stat-label">Unique Bins</div>
            </div>
            <div class="stat-card today">
                <div class="stat-number">${todayDetections.toLocaleString()}</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-card recent">
                <div class="stat-number">${recentDetections}</div>
                <div class="stat-label">Last Hour</div>
            </div>
        `;
    }

    function getSignalQuality(rssi) {
        const rssiNum = parseFloat(rssi);
        if (isNaN(rssiNum)) return { text: 'Unknown', class: '' };
        
        if (rssiNum >= -50) return { text: 'Excellent', class: '' };
        if (rssiNum >= -60) return { text: 'Good', class: '' };
        if (rssiNum >= -70) return { text: 'Fair', class: '' };
        return { text: 'Poor', class: 'poor' };
    }

    function displayBins() {
        let binStats = Array.from(getBinStats().entries()).map(([mac, data]) => ({
            mac,
            ...data
        }));

        if (wasteTypeFilter !== 'all') {
            binStats = binStats.filter(bin => bin.wasteType === wasteTypeFilter);
        }

        if (binSizeFilter !== 'all') {
            binStats = binStats.filter(bin => bin.binSize === binSizeFilter);
        }

        if (searchTerm) {
            binStats = binStats.filter(bin => {
                const searchLower = searchTerm.toLowerCase();
                return bin.name.toLowerCase().includes(searchLower) ||
                       bin.mac.toLowerCase().includes(searchLower) ||
                       bin.wasteType.toLowerCase().includes(searchLower);
            });
        }

        binStats.sort((a, b) => b.lastSeen - a.lastSeen);

        const binsGrid = document.getElementById('binsGrid');

        if (binStats.length === 0) {
            binsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No bins found</div>';
            return;
        }

        binsGrid.innerHTML = binStats.map(bin => {
            const signalQuality = getSignalQuality(bin.avgRSSI);
            
            return `
                <div class="bin-card">
                    <div class="bin-header">
                        <div class="bin-name">${bin.name}</div>
                        <div class="detection-count">${bin.detections.length}</div>
                    </div>
                    
                    <div class="bin-info">
                        <span class="bin-info-label">MAC:</span>
                        <span class="bin-info-value">${bin.mac}</span>
                        
                        <span class="bin-info-label">Size:</span>
                        <span class="bin-info-value">${bin.binSize}</span>
                        
                        <span class="bin-info-label">Type:</span>
                        <span class="bin-info-value">${bin.wasteType}</span>
                    </div>
                    
                    <div>
                        <span class="bin-badge badge-size">${bin.binSize}</span>
                        <span class="bin-badge badge-waste">${bin.wasteType}</span>
                        <span class="bin-badge badge-signal ${signalQuality.class}">${signalQuality.text}</span>
                    </div>
                    
                    <div class="last-seen">
                        <strong>Last Seen:</strong> ${bin.lastSeen.toLocaleString()}
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayTimeline() {
        let filteredDetections = [...allDetections];
        
        const now = new Date();
        if (timelineFilter === 'today') {
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);
            filteredDetections = filteredDetections.filter(d => d.timestamp >= todayStart);
        } else if (timelineFilter === 'week') {
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            filteredDetections = filteredDetections.filter(d => d.timestamp >= weekAgo);
        } else if (timelineFilter === 'month') {
            const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            filteredDetections = filteredDetections.filter(d => d.timestamp >= monthAgo);
        }

        const timeline = document.getElementById('timeline');
        
        if (filteredDetections.length === 0) {
            timeline.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No detections in selected time period</div>';
            return;
        }

        timeline.innerHTML = filteredDetections.map(detection => {
            const name = detection.Name || detection.name || 'Unknown Bin';
            const mac = detection.MAC || detection.mac || '';
            const binSize = detection['Bin Size'] || detection.binSize || '';
            const wasteType = detection['Waste Type'] || detection.wasteType || '';
            const rssi = detection.RSSI || detection.rssi || '';
            const quality = detection.Quality || detection.quality || '';
            
            return `
                <div class="timeline-event">
                    <div class="timeline-time-col">
                        <div class="timeline-time">${detection.timestamp.toLocaleTimeString()}</div>
                        <div class="timeline-date">${detection.timestamp.toLocaleDateString()}</div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-bin-name">${name}</div>
                        <div class="timeline-details">
                            ${binSize} • ${wasteType} • Signal: ${rssi} dBm (${quality})
                        </div>
                        <div class="timeline-details" style="font-size: 0.8em; margin-top: 4px;">
                            MAC: ${mac}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('calendarTitle').textContent =
            currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - startDate.getDay());

        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        let html = '<div class="month-grid">';

        days.forEach(day => {
            html += `<div class="day-header">${day}</div>`;
        });

        for (let i = 0; i < 42; i++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + i);

            const isOtherMonth = currentDay.getMonth() !== month;
            const dayDetections = allDetections.filter(d =>
                d.timestamp.toDateString() === currentDay.toDateString()
            );

            html += `<div class="day-cell ${isOtherMonth ? 'other-month' : ''}">
                <div class="day-number">${currentDay.getDate()}</div>`;

            if (dayDetections.length > 0) {
                html += `<div class="day-count">${dayDetections.length}</div>`;
            }

            html += `</div>`;
        }

        html += '</div>';
        document.getElementById('calendarContent').innerHTML = html;
    }

    function updateLastUpdated() {
        const now = new Date();
        const textElement = document.getElementById('lastUpdatedText');
        if (textElement) {
            textElement.textContent = `Last updated: ${now.toLocaleString()} • Auto-refresh: 30s`;
        }
    }

    function manualRefresh() {
        loadData(true);
    }

    function exportToCSV() {
        let dataToExport = [];
        let filename = '';

        if (currentView === 'dashboard') {
            let binStats = Array.from(getBinStats().entries()).map(([mac, data]) => ({
                'Bin Name': data.name,
                'MAC Address': mac,
                'Bin Size': data.binSize,
                'Waste Type': data.wasteType,
                'Total Detections': data.detections.length,
                'Last Seen': data.lastSeen.toLocaleString(),
                'Avg Signal (dBm)': data.avgRSSI,
                'Signal Quality': data.avgQuality
            }));

            dataToExport = binStats;
            filename = `binspy-rfid-summary-${new Date().toISOString().split('T')[0]}.csv`;

        } else if (currentView === 'timeline') {
            let filteredDetections = [...allDetections];
            
            const now = new Date();
            if (timelineFilter === 'today') {
                const todayStart = new Date(now);
                todayStart.setHours(0, 0, 0, 0);
                filteredDetections = filteredDetections.filter(d => d.timestamp >= todayStart);
            } else if (timelineFilter === 'week') {
                const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                filteredDetections = filteredDetections.filter(d => d.timestamp >= weekAgo);
            } else if (timelineFilter === 'month') {
                const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                filteredDetections = filteredDetections.filter(d => d.timestamp >= monthAgo);
            }

            dataToExport = filteredDetections.map(d => ({
                'Timestamp': d.timestamp.toLocaleString(),
                'Bin Name': d.Name || d.name,
                'MAC Address': d.MAC || d.mac,
                'Bin Size': d['Bin Size'] || d.binSize,
                'Waste Type': d['Waste Type'] || d.wasteType,
                'Signal (dBm)': d.RSSI || d.rssi,
                'Quality': d.Quality || d.quality,
                'Device Time': d['Device Time'] || d.deviceTime
            }));

            filename = `binspy-rfid-detections-${timelineFilter}-${new Date().toISOString().split('T')[0]}.csv`;

        } else if (currentView === 'calendar') {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthDetections = allDetections.filter(d =>
                d.timestamp.getFullYear() === year &&
                d.timestamp.getMonth() === month
            );

            dataToExport = monthDetections.map(d => ({
                'Timestamp': d.timestamp.toLocaleString(),
                'Bin Name': d.Name || d.name,
                'MAC Address': d.MAC || d.mac,
                'Bin Size': d['Bin Size'] || d.binSize,
                'Waste Type': d['Waste Type'] || d.wasteType,
                'Signal (dBm)': d.RSSI || d.rssi,
                'Quality': d.Quality || d.quality
            }));

            filename = `binspy-rfid-${currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' }).replace(' ', '-')}.csv`;
        }

        if (dataToExport.length === 0) {
            alert('No data to export');
            return;
        }

        const csv = Papa.unparse(dataToExport);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData(false);

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.view;
                displayCurrentView();
            });
        });

        document.getElementById('searchBox').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            displayBins();
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                const filterType = e.target.dataset.filterType;
                const filterValue = e.target.dataset.filter;
                
                if (filterType === 'waste') {
                    document.querySelectorAll('[data-filter-type="waste"]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    wasteTypeFilter = filterValue;
                } else if (filterType === 'size') {
                    document.querySelectorAll('[data-filter-type="size"]').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    binSizeFilter = filterValue;
                }
                
                displayBins();
            }
        });

        document.getElementById('timelineFilter').addEventListener('change', (e) => {
            timelineFilter = e.target.value;
            displayTimeline();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            displayCalendar();
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            displayCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            currentDate = new Date();
            displayCalendar();
        });
    });

    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadData(true);
        updateHeartbeatDisplay();
    }, 30000);

    // Update heartbeat display every 5 seconds
    setInterval(() => {
        updateHeartbeatDisplay();
    }, 5000);
</script>
</body>
</html>
