<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Keyzy Key Viewer</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/dZR7M8C.png">

  <!-- Leaflet.js for Mapping -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    crossorigin=""
  />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>

  <!-- Leaflet MarkerCluster for grouping markers -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV Parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background-color: #f2f2f7;
      overscroll-behavior-y: contain;
    }
    #app {
      height: var(--app-height, 100vh);
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f2f2f7;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #d1d1d6;
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #b2b2b7;
    }
    .leaflet-popup-content-wrapper {
      padding: 1px;
      border-radius: 12px;
      background-color: #f9f9f9;
      color: #1c1c1e;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .leaflet-popup-content {
      margin: 14px 20px;
      line-height: 1.4;
    }
    .leaflet-popup-tip-container {
      width: 40px;
      height: 20px;
    }
    .leaflet-popup-tip {
      background-color: #f9f9f9;
    }
    .leaflet-popup-close-button {
      color: #8e8e93;
    }
    .leaflet-popup-close-button:hover {
      color: #1c1c1e;
    }
    #loading-overlay {
      transition: opacity 0.3s ease-in-out;
    }
    .leaflet-container {
      background: #aadaff;
    }
    .emoji-marker {
      background: transparent;
      border: none;
      font-size: 26px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }
    
    /* Desktop sidebar collapse animation */
    #desktop-sidebar-wrapper {
      transition: margin-left 0.3s ease-in-out;
      width: 100%;
      max-width: 24rem;
    }
    #desktop-sidebar-wrapper.collapsed {
      margin-left: -24rem;
    }
    @media (min-width: 768px) and (max-width: 1024px) {
      #desktop-sidebar-wrapper {
        max-width: 33.333333%;
      }
      #desktop-sidebar-wrapper.collapsed {
        margin-left: -33.333333%;
      }
    }
    
    #mobile-list-drawer {
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }
    #mobile-list-drawer.is-collapsed {
      transform: translateY(calc(100% - 60px - env(safe-area-inset-bottom)));
    }
    .selected-marker {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0% {transform: scale(1)}
      50% {transform: scale(1.15)}
      100% {transform: scale(1)}
    }
    #login-screen {
      backdrop-filter: blur(10px);
    }
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
  </style>
</head>
<body class="text-black font-sans antialiased">
  <!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-white/95 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-200">
        <div class="text-center mb-8">
          <img src="https://i.imgur.com/wYN0A1f.png" alt="Logo" class="h-40 w-40 mx-auto mb-6" />
          <h1 class="text-3xl font-bold text-gray-800">Keyzy Key Tracking</h1>
          <p class="text-gray-600 mt-2">Please sign in to continue</p>
        </div>
        
        <form id="login-form" class="space-y-4">
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
            <input 
              type="text" 
              id="username" 
              name="username" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter username"
              autocomplete="username"
              required
            />
          </div>
          
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter password"
              autocomplete="current-password"
              required
            />
          </div>
          
          <div id="login-error" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-lg">
            Invalid username or password
          </div>
          
          <button 
            type="submit" 
            class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition-colors"
          >
            Sign In
          </button>
        </form>
        <div class="mt-6 w-full flex justify-center text-xs text-gray-500">
          <p class="whitespace-nowrap">
            2025 | Shrunk Innovation Group Pty Ltd | All Rights Reserved
          </p>
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="w-screen flex md:flex-row overflow-hidden bg-gray-100 hidden">
    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="absolute inset-0 bg-gray-100/80 backdrop-blur-sm z-50 flex items-center justify-center"
    >
      <div class="text-center">
        <svg
          class="mx-auto h-12 w-12 text-gray-400 animate-spin"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <h2 class="mt-4 text-xl font-semibold text-gray-700">
          Loading Key Data...
        </h2>
        <p class="text-gray-500">Please wait a moment.</p>
      </div>
    </div>

    <!-- Desktop Sidebar Wrapper -->
    <div id="desktop-sidebar-wrapper" class="h-full flex-shrink-0 hidden md:block">
      <!-- Desktop Sidebar -->
      <aside
        id="desktop-sidebar"
        class="w-full h-full flex-col flex bg-gray-100"
      >
        <div class="p-4 bg-gray-100 border-r border-gray-200">
          <div class="flex justify-between items-start mb-6 pt-4 px-2">
            <div class="flex flex-col items-center w-full">
              <img src="https://i.imgur.com/wYN0A1f.png" alt="Logo" class="h-12 w-12" />
              <h1 class="text-2xl font-bold text-gray-800 pt-4">Keyzy</h1>
            </div>
            <button
                id="collapse-sidebar-btn"
                title="Collapse Sidebar"
                class="p-2 text-gray-500 hover:bg-gray-200 rounded-full"
                aria-label="Collapse sidebar"
              >
                <svg viewBox="0 0 24 24" fill="none" class="h-5 w-5">
                  <path d="M21.97 15V9C21.97 4 19.97 2 14.97 2H8.97C3.97 2 1.97 4 1.97 9V15C1.97 20 3.97 22 8.97 22H14.97C19.97 22 21.97 20 21.97 15Z"
                    stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M7.97 2V22"
                    stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M14.97 9.44L12.41 12L14.97 14.56"
                    stroke="#292D32" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
               </svg>
            </button>
            <button
              id="logout-btn-desktop"
              title="Sign Out"
              class="p-2 text-red-500 hover:bg-red-100 rounded-full ml-2"
              aria-label="Sign out"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <div id="filter-panel-desktop"></div>
        </div>
        <div class="flex-grow min-h-0 bg-gray-100 border-r border-gray-200 px-2">
          <div id="key-list-container-desktop" class="h-full overflow-y-auto custom-scrollbar"></div>
        </div>
      </aside>
    </div>

    <!-- Main Content -->
    <main class="flex-grow h-full flex flex-col relative">
      <header
        id="mobile-header"
        class="bg-white/80 backdrop-blur-lg border-b border-gray-200 shadow-sm p-2 flex justify-between items-center z-20 flex-shrink-0 md:hidden"
        style="padding-top: calc(env(safe-area-inset-top) + 0.5rem); padding-bottom: 0.5rem;"
      >
        <div class="flex items-center space-x-3 pl-2">
          <h1 class="text-lg font-bold text-gray-800">Keyzy</h1>
        </div>
        <div class="flex items-center">
          <button
            id="open-filter-btn"
            class="p-2 h-auto bg-transparent text-gray-600 hover:bg-gray-200 rounded-md"
            aria-label="Open filters"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
          </button>
          <button
            id="logout-btn-mobile"
            class="p-2 h-auto bg-transparent text-red-500 hover:bg-red-100 rounded-md ml-1"
            aria-label="Sign out"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </header>

      <div class="flex-grow relative">
        <div id="map" class="w-full h-full z-10"></div>
        <button
          id="expand-sidebar-btn"
          title="Show Filters"
          class="hidden absolute top-4 left-4 z-20 bg-white p-3 rounded-lg shadow-lg text-gray-600 hover:bg-gray-100 border border-gray-300 transition-all"
          aria-label="Show filters"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
        </button>
      </div>

      <!-- Mobile Drawer for Key List -->
      <div
        id="mobile-list-drawer"
        class="is-collapsed absolute bottom-0 left-0 right-0 h-1/3 bg-white/80 backdrop-blur-lg shadow-lg overflow-hidden rounded-t-lg z-20 flex flex-col border-t border-gray-200 md:hidden"
        style="padding-bottom: env(safe-area-inset-bottom);"
      >
        <div id="mobile-list-handle" class="p-2 bg-transparent text-center cursor-grab">
          <div class="w-8 h-1 bg-gray-300 rounded-full mx-auto"></div>
          <h3 id="mobile-list-header" class="font-semibold text-gray-600 text-sm mt-1">0 Keys Found</h3>
        </div>
        <div id="key-list-container-mobile" class="flex-grow min-h-0 overflow-y-auto custom-scrollbar"></div>
      </div>

      <div id="toast" class="hidden absolute bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm transition-opacity duration-300">Location copied to clipboard!</div>
    </main>

    <!-- Mobile Drawer for Filters -->
    <div id="mobile-drawer" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden">
      <div
        id="mobile-drawer-content"
        class="absolute bottom-0 left-0 right-0 max-h-[90vh] bg-gray-100 shadow-xl rounded-t-2xl p-4 transform translate-y-full transition-transform duration-300 ease-in-out overflow-y-auto"
        style="padding-bottom: calc(env(safe-area-inset-bottom) + 1rem);"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800">Filters</h2>
          <button id="close-filter-btn" class="p-2 h-auto bg-gray-200 text-gray-600 hover:bg-gray-300 rounded-full" aria-label="Close filters">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <div id="filter-panel-mobile"></div>
      </div>
    </div>
  </div>

  <script>
    // --- AUTH CONFIG ---
    // SECURITY WARNING: This is client-side auth and NOT secure!
    // Anyone can view source and see credentials.
    // For production, use server-side authentication.
    const AUTH_CONFIG = {
      users: [
        { username: 'ISSGriffith', password: 'KeysISS2025' },
        { username: 'Shrunk', password: 'Keyzy270479' }
      ],
      sessionKey: 'keyzy_auth_session',
      sessionTimeout: 3600000 // 1 hour in milliseconds
    };

    // --- AUTH FUNCTIONS ---
    function createSession() {
      const session = {
        authenticated: true,
        timestamp: Date.now()
      };
      sessionStorage.setItem(AUTH_CONFIG.sessionKey, JSON.stringify(session));
    }

    function isAuthenticated() {
      const sessionStr = sessionStorage.getItem(AUTH_CONFIG.sessionKey);
      if (!sessionStr) return false;
      
      try {
        const session = JSON.parse(sessionStr);
        const now = Date.now();
        const elapsed = now - session.timestamp;
        
        if (elapsed > AUTH_CONFIG.sessionTimeout) {
          sessionStorage.removeItem(AUTH_CONFIG.sessionKey);
          return false;
        }
        
        return session.authenticated === true;
      } catch (e) {
        return false;
      }
    }

    function logout() {
      sessionStorage.removeItem(AUTH_CONFIG.sessionKey);
      location.reload();
    }

    function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('login-error');
      const loginForm = document.getElementById('login-form');
      
      // Check credentials against all valid users
      const validUser = AUTH_CONFIG.users.find(user => 
        user.username === username && user.password === password
      );
      
      if (validUser) {
        createSession();
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        initializeApp();
      } else {
        loginError.classList.remove('hidden');
        loginForm.classList.add('shake');
        setTimeout(() => loginForm.classList.remove('shake'), 500);
        
        // Clear password field
        document.getElementById('password').value = '';
      }
    }

    // Dynamic height for mobile browsers (reacts to address bar)
    const setAppHeight = () => {
      const doc = document.documentElement;
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      doc.style.setProperty('--app-height', `${vh}px`);
    };
    window.addEventListener('resize', setAppHeight);
    window.visualViewport && window.visualViewport.addEventListener('resize', setAppHeight);
    setAppHeight();

    // --- CONFIG ---
    const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRX2zaEdacqU0mDqiCDbvdJf9q9NgXLAhVOWwVMTdkBZG-mMU6f_GL-qWkp6x3ykijmTSAHLH150voJ/pub?output=csv';
    const EXTRA_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSLBH5SwHiP1E9aeVe4Zc_zGAdwzRHIHJWrdyqzyhlIF--wEY3EAUSqukuWN1MRCTuWeY0-ZHfwCC7V/pub?output=csv';

    // MASTER list of all 87 keys we care about
    const MASTER_KEYS = new Set([
      '6147','63261','63366','63370','63590','63594','63660','63704','63097',
      '12848','63103','12889','66545','12922','63104','12924','36855','63077',
      '63088','63096','66548','66550','63106','63142','63099','63100','63102',
      '63146','63174','66559','63143','63185','63191','63287','63258','63316',
      '63360','63288','70867','63578','63378','63380','63439','70349','70359',
      '70361','70375','63441','70803','70819','70821','63597','70833','70853',
      '70887','70888','72594','72596','63486','63491','63514','63622','63515',
      '63518','63596','63602','63608','63614','63628','63632','63635','63637',
      '63650','70891','70864','72599','63623','63645','63679','63685','72607',
      '163643','63654','63659','63690','70865','70880'
    ]);

    const INITIAL_CENTER = [-28.0167, 153.4];
    const INITIAL_ZOOM = 10;
    const TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const TILE_ATTRIBUTION = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

    // --- STATE ---
    let map;
    let markersLayer = L.markerClusterGroup({ chunkedLoading: true, chunkDelay: 16, chunkInterval: 200 });
    let pathLayer = L.layerGroup();
    let allData = [];
    let keysets = [];
    let selectedKeyId = null;
    let selectedMarker = null;
    let filters = { startDate: null, endDate: null, keyset: 'all', latestOnly: true };

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const desktopSidebarWrapper = document.getElementById('desktop-sidebar-wrapper');
    const desktopSidebar = document.getElementById('desktop-sidebar');
    const filterPanelDesktop = document.getElementById('filter-panel-desktop');
    const filterPanelMobile = document.getElementById('filter-panel-mobile');
    const keyListDesktop = document.getElementById('key-list-container-desktop');
    const keyListMobile = document.getElementById('key-list-container-mobile');
    const mobileListHeader = document.getElementById('mobile-list-header');
    const collapseBtn = document.getElementById('collapse-sidebar-btn');
    const expandBtn = document.getElementById('expand-sidebar-btn');
    const toastEl = document.getElementById('toast');
    const mobileListDrawer = document.getElementById('mobile-list-drawer');
    const mobileListHandle = document.getElementById('mobile-list-handle');

    // --- Utils ---
    const esc = (s='') => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    function toISO(s) {
      if (!s) return null;
      const [datePart, timePart=''] = String(s).trim().split(/\s+/);
      const dmy = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (dmy) {
        const [, d, m, y] = dmy;
        const [hh='00', mm='00', ss='00'] = (timePart || '').split(':');
        return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}T${hh.padStart(2,'0')}:${mm.padStart(2,'0')}:${ss.padStart(2,'0')}`;
      }
      return datePart + (timePart ? `T${timePart}` : '');
    }

    function fmtDate(s) {
      const dt = new Date(toISO(s));
      return isNaN(dt) ? 'N/A' : dt.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function parseCsv(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (res) => resolve(res.data || []),
          error: reject
        });
      });
    }

    function normalizeRow(row, idx) {
      const nameRaw = row.name ? String(row.name).replace(/^Key\s*/i, '').trim() : '';
      return {
        ...row,
        name: nameRaw,
        id: idx,
      };
    }

    function validGeo(row) {
      const lat = parseFloat(row.locationlatitude);
      const lon = parseFloat(row.locationlongitude);
      return !isNaN(lat) && !isNaN(lon);
    }

    function createFeature(row) {
      return {
        type: 'Feature',
        properties: row,
        geometry: {
          type: 'Point',
          coordinates: [parseFloat(row.locationlongitude), parseFloat(row.locationlatitude)]
        }
      };
    }

    function createFilterContent(keysetOptions) {
      return `
        <div class="space-y-6">
          <div class="bg-white rounded-xl border border-gray-200/80 shadow-sm">
            <div class="p-3 flex justify-between items-center border-b border-gray-200/80">
              <label for="startDate" class="text-sm font-medium text-gray-700">Start Date</label>
              <input type="date" name="startDate" class="text-sm border-gray-300 rounded-md" />
            </div>
            <div class="p-3 flex justify-between items-center">
              <label for="endDate" class="text-sm font-medium text-gray-700">End Date</label>
              <input type="date" name="endDate" class="text-sm border-gray-300 rounded-md" />
            </div>
          </div>
          <div class="bg-white rounded-xl border border-gray-200/80 shadow-sm p-3 flex justify-between items-center">
            <label for="keyset" class="text-sm font-medium text-gray-700">Keyset</label>
            <select name="keyset" class="w-1/2 text-sm bg-white border-gray-300 rounded-md focus:ring-0 text-right">
              <option value="all">All Keys</option>
              ${keysetOptions.map(k => `<option value="${k}">Key ${esc(k)}</option>`).join('')}
            </select>
          </div>
          <div class="bg-white rounded-xl border border-gray-200/80 shadow-sm p-3 flex justify-between items-center">
            <label for="latest-only" class="text-sm font-medium text-gray-700">Latest Location Only</label>
            <input id="latest-only" name="latestOnly" type="checkbox" class="h-5 w-5 rounded-md border-gray-300 text-blue-600 focus:ring-blue-500" ${filters.latestOnly ? 'checked' : ''} />
          </div>
          <div class="pt-4 space-y-3">
            <button name="apply" class="w-full inline-flex items-center justify-center rounded-lg text-base font-semibold bg-blue-500 text-white hover:bg-blue-600 h-11 px-4 py-2 transition-colors shadow-sm">Find</button>
            <button name="reset" class="w-full inline-flex items-center justify-center rounded-lg text-base font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 h-11 px-4 py-2 transition-colors">Reset</button>
          </div>
        </div>`;
    }

    function createKeyListItem(item, isSelected) {
      const dateStr = fmtDate(item.properties.datetime);
      const locationType = item.properties.locationpositiontype
        ? item.properties.locationpositiontype.charAt(0).toUpperCase() + item.properties.locationpositiontype.slice(1).toLowerCase()
        : null;
      const subtitleHTML = locationType ? `<span class="text-xs font-semibold text-blue-500 bg-blue-100 px-2 py-1 rounded-full">${esc(locationType)}</span>` : '';
      const shareButtonHTML = isSelected ? `
        <div class="mt-3 pt-3 border-t border-gray-200">
          <button class="message-btn w-full flex items-center justify-center text-sm font-semibold text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-colors"
            data-lat="${item.geometry.coordinates[1]}"
            data-lon="${item.geometry.coordinates[0]}"
            data-name="${esc(item.properties.name)}"
            data-address="${esc(item.properties.addresslabel || 'N/A')}"
            data-datetime="${esc(dateStr)}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
            Message Location
          </button>
        </div>` : '';

      return `
        <div class="key-list-item p-4 rounded-xl cursor-pointer transition-shadow duration-300 ${isSelected ? 'bg-white shadow-lg' : 'bg-white shadow-sm'}" data-key-id="${item.properties.__uid}">
          <div class="flex items-center justify-between">
            <p class="font-semibold text-gray-800">Key ${esc(item.properties.name)}</p>
            ${subtitleHTML}
          </div>
          <p class="text-sm text-gray-600 truncate pt-1">${esc(item.properties.addresslabel || 'Address not available')}</p>
          <p class="text-xs text-gray-500 pt-1">${esc(dateStr)}</p>
          ${shareButtonHTML}
        </div>`;
    }

    function renderKeyList(items) {
      try {
        if (items.length === 0) {
          const noResultsHTML = `<div class="p-4 text-center text-gray-500">No keys found.</div>`;
          keyListDesktop.innerHTML = noResultsHTML;
          keyListMobile.innerHTML = noResultsHTML;
          mobileListHeader.textContent = '0 Keys Found';
          return;
        }
        const listHTML = `<div class="space-y-3 p-2">${items.map(item => createKeyListItem(item, item.properties.__uid === selectedKeyId)).join('')}</div>`;
        keyListDesktop.innerHTML = listHTML;
        keyListMobile.innerHTML = listHTML;
        mobileListHeader.textContent = `${items.length} Keys Found`;

        document.querySelectorAll('.key-list-item').forEach(el => {
          el.addEventListener('click', (e) => {
            if (e.target.closest('.message-btn')) return;
            const uid = el.getAttribute('data-key-id');
            const key = allData.find(d => String(d.properties.__uid) === String(uid));
            if (key) {
              selectedKeyId = key.properties.__uid;
              map.flyTo([key.geometry.coordinates[1], key.geometry.coordinates[0]], 16);
              runFilters(false);
            }
          });
        });

        document.querySelectorAll('.message-btn').forEach(el => {
          el.addEventListener('click', handleMessageButtonClick);
        });
      } catch (err) {
        console.error('Error rendering key list:', err);
      }
    }

    function setupEventListeners() {
      const filterForms = [filterPanelDesktop, filterPanelMobile];
      filterForms.forEach(container => {
        const applyBtn = container.querySelector('button[name="apply"]');
        const resetBtn = container.querySelector('button[name="reset"]');

        if (applyBtn) {
          applyBtn.addEventListener('click', () => {
            selectedKeyId = null;
            filters.startDate = container.querySelector('[name="startDate"]').value || null;
            filters.endDate = container.querySelector('[name="endDate"]').value || null;
            filters.keyset = container.querySelector('[name="keyset"]').value;
            filters.latestOnly = container.querySelector('[name="latestOnly"]').checked;
            runFilters();
            if (container.id === 'filter-panel-mobile') toggleMobileDrawer(false);
          });
        }
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            selectedKeyId = null;
            container.querySelector('[name="startDate"]').value = '';
            container.querySelector('[name="endDate"]').value = '';
            container.querySelector('[name="keyset"]').value = 'all';
            container.querySelector('[name="latestOnly"]').checked = true;
            filters = { startDate: null, endDate: null, keyset: 'all', latestOnly: true };
            runFilters();
          });
        }
      });

      collapseBtn.addEventListener('click', () => toggleDesktopSidebar(false));
      expandBtn.addEventListener('click', () => toggleDesktopSidebar(true));

      const mobileDrawer = document.getElementById('mobile-drawer');
      document.getElementById('open-filter-btn').addEventListener('click', () => toggleMobileDrawer(true));
      document.getElementById('close-filter-btn').addEventListener('click', () => toggleMobileDrawer(false));
      mobileDrawer.addEventListener('click', (e) => { if (e.target === mobileDrawer) toggleMobileDrawer(false); });

      // Logout buttons
      document.getElementById('logout-btn-desktop').addEventListener('click', logout);
      document.getElementById('logout-btn-mobile').addEventListener('click', logout);

      // Mobile list handle tap/drag
      let touchStartY = 0;
      mobileListHandle.addEventListener('click', () => setListDrawerState(!mobileListDrawer.classList.contains('is-collapsed')));
      mobileListHandle.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
      mobileListHandle.addEventListener('touchend', (e) => {
        if (touchStartY === 0) return;
        const touchEndY = e.changedTouches[0].clientY;
        const deltaY = touchEndY - touchStartY;
        touchStartY = 0;
        if (Math.abs(deltaY) < 50) return;
        setListDrawerState(deltaY > 0);
      });
    }

    async function handleMessageButtonClick(e) {
      e.stopPropagation();
      const button = e.currentTarget;
      const lat = button.dataset.lat;
      const lon = button.dataset.lon;
      const name = button.dataset.name;
      const address = button.dataset.address;
      const datetime = button.dataset.datetime;
      const g = `https://maps.google.com/?q=${lat},${lon}`;
      const a = `http://maps.apple.com/?ll=${lat},${lon}`;
      const shareData = {
        title: 'The last Keyzy location for',
        text: `The last Keyzy location for\n\nKey ${name}\nAddress: ${address}\nTime: ${datetime}\n\nView on map:\nGoogle: ${g}\nApple: ${a}`,
      };
      try {
        if (navigator.share) await navigator.share(shareData);
        else throw new Error('Web Share API not supported.');
      } catch (err) {
        try { await navigator.clipboard.writeText(shareData.text); showToast('Location copied to clipboard!'); }
        catch { showToast('Failed to copy location.'); }
      }
    }

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.remove('hidden');
      setTimeout(() => toastEl.classList.add('hidden'), 3000);
    }

    function toggleDesktopSidebar(show) {
      if (show) { 
        desktopSidebarWrapper.classList.remove('collapsed'); 
        expandBtn.classList.add('hidden'); 
      }
      else { 
        desktopSidebarWrapper.classList.add('collapsed'); 
        expandBtn.classList.remove('hidden'); 
      }
      setTimeout(() => map && map.invalidateSize(), 310);
    }
    
    function setListDrawerState(collapsed) {
      mobileListDrawer.classList.toggle('is-collapsed', collapsed);
      setTimeout(() => map && map.invalidateSize(), 310);
    }
    
    function toggleMobileDrawer(show) {
      const drawer = document.getElementById('mobile-drawer');
      const content = document.getElementById('mobile-drawer-content');
      if (show) { drawer.classList.remove('hidden'); setTimeout(() => content.classList.remove('translate-y-full'), 10); }
      else { content.classList.add('translate-y-full'); setTimeout(() => drawer.classList.add('hidden'), 300); }
    }

    async function fetchData() {
      loadingOverlay.style.opacity = '1';
      loadingOverlay.classList.remove('hidden');
      try {
        const [mainRowsRaw, extraRowsRaw] = await Promise.all([
          parseCsv(GOOGLE_SHEET_URL),
          parseCsv(EXTRA_SHEET_URL)
        ]);

        // Normalize
        let mainRows = mainRowsRaw.map(normalizeRow);
        let extraRows = extraRowsRaw.map(normalizeRow);

        // Keep only our master keys with valid coordinates
        mainRows = mainRows.filter(r => MASTER_KEYS.has(String(r.name)) && validGeo(r));
        extraRows = extraRows.filter(r => MASTER_KEYS.has(String(r.name)) && validGeo(r));

        // Merge
        const merged = [...mainRows, ...extraRows];

        // Assign stable uid per row
        merged.forEach((r, i) => (r.__uid = `row_${i}`));

        // Convert to features
        allData = merged
          .filter(r => r.datetime && r.name)
          .sort((a, b) => new Date(toISO(b.datetime)) - new Date(toISO(a.datetime)))
          .map(r => createFeature(r));

        // Build keyset list from all data
        keysets = [...new Set(allData.map(item => item.properties.name))].sort((a, b) => {
          const numA = parseInt(a), numB = parseInt(b);
          return (!isNaN(numA) && !isNaN(numB)) ? numA - numB : String(a).localeCompare(String(b));
        });

        const filterHTML = createFilterContent(keysets);
        filterPanelDesktop.innerHTML = filterHTML;
        filterPanelMobile.innerHTML = filterHTML;

        setupEventListeners();
        initializeMap();
        runFilters();
      } catch (err) {
        console.error('Error fetching or parsing data:', err);
        loadingOverlay.innerHTML = `<div class="p-4 text-center text-red-600"><strong>Error:</strong> Failed to download key data from the source(s).</div>`;
      } finally {
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
        }, 500);
      }
    }

    function runFilters(fitMapToBounds = true) {
      try {
        let data = [...allData];

        const dateInRange = (s, startISO, endISO) => {
          const iso = toISO(s);
          if (!iso) return false;
          const d = iso.slice(0,10);
          if (startISO && d < startISO) return false;
          if (endISO && d > endISO) return false;
          return true;
        };

        if (filters.startDate) data = data.filter(it => dateInRange(it.properties.datetime, filters.startDate, null));
        if (filters.endDate) data = data.filter(it => dateInRange(it.properties.datetime, null, filters.endDate));
        if (filters.keyset !== 'all') data = data.filter(it => String(it.properties.name) === String(filters.keyset));

        if (filters.latestOnly) {
          const latest = new Map();
          for (const it of data) {
            const key = it.properties.name;
            const t = new Date(toISO(it.properties.datetime)).getTime();
            const prev = latest.get(key);
            if (!prev || t > prev.t) latest.set(key, { t, it });
          }
          data = Array.from(latest.values()).map(v => v.it);
        }

        // Keep newest-first for list
        data.sort((a, b) => new Date(toISO(b.properties.datetime)) - new Date(toISO(a.properties.datetime)));

        renderKeyList(data);
        updateMapData(data, fitMapToBounds);
      } catch (err) {
        console.error('Error during filtering:', err);
      }
    }

    function initializeMap() {
      try {
        map = L.map('map', { zoomControl: false }).setView(INITIAL_CENTER, INITIAL_ZOOM);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer(TILE_URL, { attribution: TILE_ATTRIBUTION, maxZoom: 18 }).addTo(map);
        markersLayer.addTo(map);
        pathLayer.addTo(map);
      } catch (err) {
        console.error('Failed to initialize map:', err);
        document.getElementById('map').innerHTML = `<div class="p-4 text-center text-red-600"><strong>Error:</strong> Map could not be loaded.</div>`;
      }
    }

    function updateMapData(data, fitMapToBounds = true) {
      if (!map) return;
      markersLayer.clearLayers();
      pathLayer.clearLayers();
      selectedMarker = null;

      if (!data.length) return;

      const keyIcon = (selected = false) => L.divIcon({
        html: selected ? 'ðŸŽ¯' : 'ðŸ”‘',
        className: 'emoji-marker' + (selected ? ' selected-marker' : ''),
        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -25]
      });

      data.forEach(item => {
        const lat = item.geometry.coordinates[1];
        const lon = item.geometry.coordinates[0];
        const dateStr = fmtDate(item.properties.datetime);
        const popupContent = `
          <div class="p-2">
            <h3 class="font-bold text-base mb-1">Key ${esc(item.properties.name)}</h3>
            <p class="text-sm text-gray-600">${esc(item.properties.addresslabel || 'Address not available')}</p>
            <p class="text-xs text-gray-500 mt-1">${esc(dateStr)}</p>
          </div>`;
        const m = L.marker([lat, lon], { icon: keyIcon(item.properties.__uid === selectedKeyId) }).bindPopup(popupContent);
        markersLayer.addLayer(m);
      });

      // Draw path if a single keyset is selected and we have a trail
      if (filters.keyset !== 'all' && !filters.latestOnly && data.length > 1) {
        const pathData = [...data].sort((a, b) => new Date(toISO(a.properties.datetime)) - new Date(toISO(b.properties.datetime)));
        const latlngs = pathData.map(it => [it.geometry.coordinates[1], it.geometry.coordinates[0]]);
        const polyline = L.polyline(latlngs, { color: '#0A84FF', weight: 3, opacity: 0.8 });
        pathLayer.addLayer(polyline);
      }

      if (fitMapToBounds && data.length > 0) {
        const bounds = markersLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
      }
    }

    function initializeApp() {
      fetchData();
    }

    // --- APP INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication
      if (isAuthenticated()) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').classList.remove('hidden');
        initializeApp();
      } else {
        // Show login screen
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('username').focus();
      }
    });
  </script>
</body>
</html>
